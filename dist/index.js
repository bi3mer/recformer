class d{x;y;constructor(t,i){this.x=t,this.y=i}}function v(t){return new d(t.x,t.y)}function di(t,i){return t.x==i.x&&t.y==i.y}function z(t,i){return new d(t.x+i.x,t.y+i.y)}function jt(t,i){t.x+=i.x,t.y+=i.y}function P(t,i){return new d(t.x-i.x,t.y-i.y)}function M(t,i){t.x+=i,t.y+=i}function w(t,i){return new d(t.x*i,t.y*i)}function mi(t,i){t.x*=i,t.y*=i}function pi(t){return t.x*t.x+t.y*t.y}function Oi(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function li(t){let i=Oi(t);t.x/=i,t.y/=i}function bt(t,i){let r=t.x-i.x,o=t.y-i.y;return r*r+o*o}function Bt(t,i){return Math.atan2(i.y-t.y,i.x-t.x)}function bi(t,i){return Math.floor(Math.random()*(i-t+1)+t)}function xt(t){return t*2-1}function B(){return Math.random()<0.5}function yt(t,i,r){return Math.min(Math.max(t,i),r)}function vt(t,i,r,o){return pi(P(r,new d(yt(r.x,t.x,t.x+i.x),yt(r.y,t.y,t.y+i.y))))<o*o}function yi(t,i,r,o){let{x:n,y:s}=t,e=n+i.x,u=s+i.y,h=r.x,x=r.y,C=h+o.x,j=x+o.y;return n<C&&e>h&&s<j&&u>x}var xi=typeof window!=="undefined",$=[];function vi(t){$.push(new Audio("audio/coin_1.wav")),$.push(new Audio("audio/coin_2.wav")),$.push(new Audio("audio/coin_3.wav")),$.push(new Audio("audio/coin_4.wav")),$.push(new Audio("audio/coin_5.wav")),$.push(new Audio("audio/laser.wav"));let i=()=>{let r=!0;for(let o=0;o<$.length;++o)if(!$[o].readyState){r=!1;break}if(r)$[5].volume=0.4,t();else setTimeout(i,100)};i()}function ai(){if(xi){let t=bi(0,4);$[t].currentTime=0.15,$[t].play()}}function gi(){if(xi)$[5].currentTime=0,$[5].play()}var I;((m)=>{m[m.LEFT=0]="LEFT";m[m.RIGHT=1]="RIGHT";m[m.DOWN=2]="DOWN";m[m.UP=3]="UP";m[m.A=4]="A";m[m.D=5]="D";m[m.E=6]="E";m[m.G=7]="G";m[m.H=8]="H";m[m.I=9]="I";m[m.Q=10]="Q";m[m.R=11]="R";m[m.S=12]="S";m[m.W=13]="W";m[m.SPACE=14]="SPACE";m[m.ESCAPE=15]="ESCAPE";m[m.ENTER=16]="ENTER";m[m.SHIFT=17]="SHIFT";m[m.INVALID=18]="INVALID"})(I||={});class b{static _keys=[];static init(){for(let t=0;t<Object.keys(I).length;++t)b._keys.push(!1);window.addEventListener("keydown",b.onKeyDown),window.addEventListener("keyup",b.onKeyUp)}static isKeyDown(...t){let i=t.length;for(let r=0;r<i;++r)if(b._keys[t[r]])return!0;return!1}static keyStrToKey(t){switch(t){case"Down":case"ArrowDown":return 2;case"Up":case"ArrowUp":return 3;case"Right":case"ArrowRight":return 1;case"Left":case"ArrowLeft":return 0;case" ":case"Space":return 14;case"Escape":return 15;case"a":case"A":return 4;case"e":case"E":return 6;case"s":case"S":return 12;case"d":case"D":return 5;case"w":case"W":return 13;case"r":case"R":return 11;case"q":case"Q":return 10;case"g":case"G":return 7;case"h":case"H":return 8;case"i":case"I":return 9;case"Shift":return 17;case"Enter":return 16;default:return console.warn(`Unhandled key: ${t}.`),18}}static onKeyDown(t){let i=b.keyStrToKey(t.key);if(b._keys[i]=!0,i==2||i==3||i==0||i==1)t.preventDefault();return!1}static onKeyUp(t){return b._keys[b.keyStrToKey(t.key)]=!1,!1}static clear(){for(let t=0;t<b._keys.length;++t)b._keys[t]=!1}}class St{scenes={};registerScene(t,i){if(this.scenes[t]===void 0)this.scenes[t]=i;else console.error(`Key "${t}" for scene already exists! Scene not added to SceneManager.`)}getScene(t){return this.scenes[t]}}var g="#fe546f";var F="#ffd080",O="#fffdff",wi="#0bffe6";var at="#9696ff";var ci="#130833";var c=720,Q=480,l=32,q=15,$i=q+2,Fi=3,qi=2*Math.PI,gt=0,wt=1,ct=2,_=20,G=30,Gi=_/l,Ki=G/l,zi=new d(Gi,Ki),J=31,W=31,R=J/l,Hi=W/l,K=new d(R,Hi),H=16,T=16,Ti=H/l,Li=T/l,$t=new d(Ti,Li),E=25,tt=15,Qi=E/l,Ji=tt/l,Xi=new d(Qi,Ji),Ui=new d(Ji,Qi),Yt=10,ki=Yt/l,Wt=2.5,Rt=R/8,Vi=J/8,Ft=0.6,Ai=2,Pi=2.5,Zi=150,Ni=10,Ci=10,ji=10,qt=H/l,Di=T/l,Bi=new d(qt,Di),U="start",it="end",p="death";class k{changeScene;onExit(){this.changeScene=void 0,this._onExit()}}class Mt extends k{ctx;constructor(t){super();this.ctx=t}onEnter(){this.ctx.clearRect(0,0,c,Q),this.ctx.font="30px Arial",this.ctx.fillStyle=O,this.ctx.fillText("You won! Congratulations!",170,Q/2)}update(t){}render(){}_onExit(){}}var rt="main menu",S="game",zt="player won",V="transition",Qt="lost",ot="won";class It extends k{ctx;transitionScene;constructor(t,i){super();this.ctx=t,this.transitionScene=i}onEnter(){b.clear(),this.ctx.fillStyle=F,this.ctx.font="48px Arial",this.ctx.fillText("YOU WON",250,200),this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to keep going.",180,400)}update(t){if(b.isKeyDown(14))this.transitionScene.targetScene=S,this.changeScene=V}render(){}_onExit(){}}class Ot extends k{ctx;transitionScene;constructor(t,i){super();this.ctx=t,this.transitionScene=i}onEnter(){b.clear(),this.ctx.fillStyle=g,this.ctx.font="48px Arial",this.ctx.fillText("YOU LOST",243,200),this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to try again.",195,400)}update(t){if(b.isKeyDown(14))this.transitionScene.targetScene=S,this.changeScene=V}render(){}_onExit(){}}class Gt{changeScene;onExit(){this.changeScene=void 0,this._onExit()}}class Kt extends Gt{targetScene=rt;timer=0;ctx;constructor(t){super();this.ctx=t}onEnter(){}update(t){if(this.timer+=t,this.timer>0.5)this.changeScene=this.targetScene}render(){let t=this.timer/0.5;this.ctx.fillStyle=`rgba(0,0,0, ${t})`,this.ctx.fillRect(0,0,c,Q)}_onExit(){this.timer=0}}var Ei=Math.floor(c/l)-1;class Ht extends k{ctx;transitionScene;fakePlayerPos;sign;constructor(t,i){super();this.ctx=t,this.transitionScene=i,this.fakePlayerPos=new d(10,(q-2)*l),this.sign=1}onEnter(){this.ctx.clearRect(0,0,c,Q),this.ctx.fillStyle=F,this.ctx.font="48px Arial",this.ctx.fillText("Recformer",247,100),this.ctx.fillStyle=F,this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to start",220,Q*0.55);let t=this.fakePlayerPos.y+l;this.ctx.strokeStyle="white";for(let i=0;i<25;++i)this.ctx.strokeRect(i*l,t,J,W)}update(t){if(b.isKeyDown(14))this.transitionScene.targetScene=S,this.changeScene=V;let i=this.fakePlayerPos.x;if(i<1||i>Ei)this.sign*=-1;this.fakePlayerPos.x+=t*this.sign}render(){let t=this.fakePlayerPos.x*l,i=(q-2)*l;this.ctx.fillStyle=ci,this.ctx.clearRect(0,this.fakePlayerPos.y,c,G),this.ctx.fillStyle=at,this.ctx.fillRect(t,i,_,G)}_onExit(){}}class Tt{startCol=0;endCol=0;offsetX=0;colsPerScreen=Math.ceil(c/l);update(t){let i=t-this.colsPerScreen/2;this.startCol=Math.max(0,Math.floor(i)),this.endCol=this.startCol+this.colsPerScreen,this.offsetX=-i*l+this.startCol*l}columnToScreen(t){return(t-this.startCol)*l+this.offsetX}rowToScreen(t){return t*l}}class Lt{src;tgt;probability;constructor(t,i,r){this.src=t,this.tgt=i,this.probability=r}}class nt{name;reward;utility;isTerminal;neighbors;constructor(t,i,r,o,n){this.name=t,this.reward=i,this.utility=r,this.isTerminal=o,this.neighbors=n}}class Jt{nodes;edges;constructor(){this.nodes={},this.edges={}}getNode(t){return this.nodes[t]}hasNode(t){return t in this.nodes}addNode(t){this.nodes[t.name]=t}addDefaultNode(t,i=1,r=0,o=!1,n=null){if(n==null)n=[];this.nodes[t]=new nt(t,i,r,o,n)}removeNode(t){let i=[];for(let r of Object.values(this.edges)){if(r.src==t||r.tgt==t)i.push(r);let o=r.probability,n=-1;for(let h=0;h<o.length;h++){let[x,C]=o[h];if(x==t){n=h;break}}if(n==-1)continue;let s=o[n][1];o.splice(n,1);let e=o.length,u=s/e;r.probability=o.map(([h,x])=>[h,x+u])}for(let r of i)this.removeEdge(r.src,r.tgt);delete this.nodes[t]}getEdge(t,i){return this.edges[`${t},${i}`]}hasEdge(t,i){return`${t},${i}`in this.edges}addEdge(t){this.edges[`${t.src},${t.tgt}`]=t;let i=this.nodes[t.src].neighbors;if(!i.includes(t.tgt))i.push(t.tgt)}addDefaultEdge(t,i,r=null){if(r==null)r=[[i,1]];this.addEdge(new Lt(t,i,r))}removeEdge(t,i){let r=this.nodes[t],o=r.neighbors.indexOf(i);r.neighbors.splice(o,1),delete this.edges[`${t},${i}`]}neighbors(t){return this.nodes[t].neighbors}setNodeUtilities(t){for(let[i,r]of Object.entries(t))this.nodes[i].utility=r}utility(t){return this.nodes[t].utility}reward(t){return this.nodes[t].reward}isTerminal(t){return this.nodes[t].isTerminal}mapNodes(t){for(let i of Object.values(this.nodes))t(i)}mapEdges(t){for(let i of Object.values(this.edges))t(i)}}function Y(t){return t[Math.floor(Math.random()*t.length)]}function L(t,i,r,o){let n=t.getEdge(i,r).probability,s=n.length,e=0;for(let u=0;u<s;++u){let[h,x]=n[u];e+=x*(t.reward(h)+o*t.utility(h))}return e}function Xt(t,i,r){let o=t.getNode(i);if(o.isTerminal)return 0;let n=o.neighbors,s=n.length,e=-1/0;for(let u=0;u<s;++u)e=Math.max(e,L(t,i,n[u],r));return e}function Dt(t){for(let i in t.nodes)t.nodes[i].utility=0}function _t(t){let i={};for(let r in t.nodes)if(!t.getNode(r).isTerminal)i[r]=[...t.neighbors(r)];return i}function Et(t,i){let r={};for(let o in t.nodes){if(t.getNode(o).isTerminal)continue;let n=-1/0,s=[];for(let e of t.neighbors(o)){let u=L(t,o,e,i);if(u===n)s.push(e);else if(u>n)n=u,s.length=0,s.push(e)}r[o]=s}return r}function tr(t,i,r,o){for(let n=0;n<o;++n)for(let s in t.nodes){let e=t.getNode(s);if(!e.isTerminal)e.utility=L(t,s,Y(i[s]),r)}}function ir(t,i,r,o){for(let n=0;n<o;++n){let s={};for(let e in t.nodes)if(!t.getNode(e).isTerminal)s[e]=L(t,e,Y(i[e]),r);t.setNodeUtilities(s)}}function rr(t,i,r,o){for(let n=0;n<o;++n)for(let s in t.nodes)t.getNode(s).utility=Xt(t,s,r)}function or(t,i,r,o){for(let n=0;n<o;++n){let s={};for(let e in t.nodes)s[e]=Xt(t,e,r);t.setNodeUtilities(s)}}function Si(t,i,r){let o=!1;for(let n in t.nodes){if(t.getNode(n).isTerminal)continue;let s=null,e=-1/0;for(let u of t.neighbors(n)){let h=L(t,n,u,r);if(h===e);else if(h>e)s=u,e=h}if(Y(i[n])!==s)i[n].length=0,i[n].push(s),o=!0}return o}function ti(t,i,r=!1,o=!1,n=10,s=!0){if(s)Dt(t);let e=_t(t),u;if(r&&o)u=tr;else if(r&&!o)u=ir;else if(!r&&o)u=rr;else u=or;let h=!0;while(h)u(t,e,i,n),h=Si(t,e,i);return u(t,e,i,n),Si(t,e,i),Et(t,i)}class a extends nt{visitedCount;sumPercentCompleted;depth;designerReward;playerReward;constructor(t,i,r,o,n,s){super(t,i,r,o,n);this.designerReward=i,this.playerReward=0,this.depth=s,this.visitedCount=1,this.sumPercentCompleted=1}updateReward(){this.reward=this.designerReward*this.visitedCount}}var f=new Jt;f.addNode(new a(U,0,0,!1,[],-1));f.addNode(new a(p,-1,0,!0,[],-1));f.addNode(new a(it,1,0,!0,[],-1));f.addNode(new a("1-a",-0.95,0,!1,[],1));f.addNode(new a("2-a",-0.925,0,!1,[],2));f.addNode(new a("2-b",-0.925,0,!1,[],2));f.addNode(new a("3-a",-0.9,0,!1,[],3));f.addNode(new a("3-b",-0.9,0,!1,[],3));f.addNode(new a("4-a",-0.825,0,!1,[],4));f.addNode(new a("4-b",-0.825,0,!1,[],4));f.addNode(new a("5-a",-0.8,0,!1,[],5));f.addNode(new a("5-b",-0.8,0,!1,[],5));f.addNode(new a("5-c",-0.8,0,!1,[],5));f.addNode(new a("6-a",-0.775,0,!1,[],6));f.addNode(new a("7-a",-0.75,0,!1,[],7));f.addNode(new a("6-b",-0.775,0,!1,[],6));f.addNode(new a("1-b",-0.95,0,!1,[],1));f.addDefaultEdge(U,"1-a",[["1-a",0.99],[p,0.01]]);f.addDefaultEdge("1-a","2-b",[["2-b",0.99],[p,0.01]]);f.addDefaultEdge("1-a","2-a",[["2-a",0.99],[p,0.01]]);f.addDefaultEdge("2-a","3-a",[["3-a",0.99],[p,0.01]]);f.addDefaultEdge("2-b","3-b",[["3-b",0.99],[p,0.01]]);f.addDefaultEdge("3-a","4-b",[["4-b",0.99],[p,0.01]]);f.addDefaultEdge("3-a","4-a",[["4-a",0.99],[p,0.01]]);f.addDefaultEdge("3-b","4-b",[["4-b",0.99],[p,0.01]]);f.addDefaultEdge("3-b","4-a",[["4-a",0.99],[p,0.01]]);f.addDefaultEdge("4-a","5-b",[["5-b",0.99],[p,0.01]]);f.addDefaultEdge("4-a","5-a",[["5-a",0.99],[p,0.01]]);f.addDefaultEdge("4-a","5-c",[["5-c",0.99],[p,0.01]]);f.addDefaultEdge("4-b","5-b",[["5-b",0.99],[p,0.01]]);f.addDefaultEdge("4-b","5-a",[["5-a",0.99],[p,0.01]]);f.addDefaultEdge("4-b","5-c",[["5-c",0.99],[p,0.01]]);f.addDefaultEdge("5-a","6-a",[["6-a",0.99],[p,0.01]]);f.addDefaultEdge("5-a","6-b",[["6-b",0.99],[p,0.01]]);f.addDefaultEdge("5-b","6-a",[["6-a",0.99],[p,0.01]]);f.addDefaultEdge("5-b","6-b",[["6-b",0.99],[p,0.01]]);f.addDefaultEdge("5-c","6-a",[["6-a",0.99],[p,0.01]]);f.addDefaultEdge("5-c","6-b",[["6-b",0.99],[p,0.01]]);f.addDefaultEdge("6-a","7-a",[["7-a",0.99],[p,0.01]]);f.addDefaultEdge("7-a","end",[["end",0.99],[p,0.01]]);f.addDefaultEdge("6-b","7-a",[["7-a",0.99],[p,0.01]]);f.addDefaultEdge(U,"1-b",[["1-b",0.99],[p,0.01]]);f.addDefaultEdge("1-b","2-b",[["2-b",0.99],[p,0.01]]);f.addDefaultEdge("1-b","2-a",[["2-a",0.99],[p,0.01]]);var Yi={"1-a":["------------XXX-","-------------T--","----------------","----------------","----------------","----------------","----------------","----------------","-----X-C-----X--","--------------b-","-----------o----","--------o-XX----","------o-XXXX----","------XXXXXX----","XXXXXXXXXXXX^XXX"],"2-a":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","-------XXXXXXXX-------","----------------------","-------V--o---V-----o-","----------------------","XXXXXXXXXXXXXXXXXXXXXX"],"2-b":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","-----------o----------","--------------------o-","-----X---H-----X------","XXXXXXXXXXXXXXXXXXXXXX"],"3-a":["----------------------","----------------------","----------------------","----------------------","-----------o----------","----------------------","---------XXXXX--------","-----------o----------","----------------------","-------X-H-----X------","---XX--XXXXXXXXX--XX--","----------------------","-------V---o---V----o-","----------------------","XXXXXXXXXXXXXXXXXXXXXX"],"3-b":["----------------------","----------------------","----------------------","----------------------","----------o-----------","----------------------","--------XXXXX---------","--------V---V---------","----------o-----------","----------------------","------XXXXXXXXX-------","----------------------","----------o---------o-","-----X---H-----X------","XXXXXXXXXXXXXXXXXXXXXX"],"4-a":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------XXX---","-----------------V----","-------X---XX-----V---","------XX------o-V---o-","-----XXX--------------","XXXXXXXX---XXXXXXXXXXX"],"4-b":["--------------------XX","--------------------XX","--------------------XX","--------------------XX","--------------------XX","-----------X-H---o--XX","-----------------o--XX","---------o----------XX","-----------XXXXXXX--XX","--------------------XX","-------X------------XX","------XXX-----------XX","-----XXXXX-----------o","----XXXXXXX-----------","XXXXXXXXXXXXXXXX--XXXX"],"5-a":["--------XXXXXXXXXXXXXX--------","-------------------ooX--------","---------------------X--------","---------------------X--------","------------------XXXX--------","------------------X-----------","-----------o--XXXXX-----------","------------------------------","---------XX-----------------o-","------------------------------","--------------XX---XXX----XXXX","------------------------------","----------XX------------------","------------------------------","XXXXXXXX----------------------"],"5-b":["------------------------------","-o----------------------------","------------------------------","XXX---------------------------","------------------------------","-----XXX----------------------","------------------------------","-----------XXX----------------","-o--------------------------o-","------XXX---------------------","XXX-----------------------XXXX","------------XXX-------XX------","------------------XX----------","------------------------------","XXXXXXXX---XXXXX--------------"],"5-c":["o-----------------------------","------------------------------","X---XX------------------------","------------------------------","------------------------------","XX----------------------------","--------XXXXX-----------------","--------Xoo-------------------","XXX-----Xoo----o------------o-","--------X---------------------","--------XXX---XX----XX----XXXX","XXXX--------------------------","------------------------------","------------------------------","XXXXXXXX----------------------"],"6-a":["----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","-------oo---XXXXXXXX----------","-o----------XXXXXXXX----------","------XXXX--XXXXXXXX----------","--------------o---------------","XXXX--------------------------","-------------XXXX-----------o-","---------------------XX-------","XXXXXXXX-----------------XXXXX"],"7-a":["-------------------V---------------","-----------------o---o-------------","------------X-H------------H--XXX--","-----V------XXXXXXXXXXXXXXXXXXXXX--","--------XX----o--------------------","-----------------------------------","-----------XXXXXX---Ho-------------","-----------------------------------","-------------V------XX--------H----","-----------------------------------","XX--------o------XXXXX----H--------","-----------------------------------","---X----H----H-X-----------------o-","---XXXXXXXXXXXXX-------------------","XXXX--------------------------XXXXX"],end:["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----oooooooooooooooooo","XXXXXXXXXXXXXXXXXXXXXX"],"6-b":["----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX--o-------","-o--------XXXXXXXXXX----------","----------XXXXXXXXXX--X-------","----------XXXXXXXXXX----------","XXX-------XXXXXXXXXXX---------","------XX-----oooo-----------o-","------------------------------","XXXX--------XXXXXX---XX---XXXX"],"1-b":["---------XXX----","----------T-----","----------------","----------------","----------------","----------------","----------------","----X-----X-----","-------oo------C","----------------","-------XX-------","----o-XXXX-o----","-----XXXXXX-----","---XXXXXXXXXX---","XXXXXXXXXXXXXXXX"]};class ii{playerIsOnLastLevel=!1;keys;columnsPerLevel;lossesInARow=0;playerWonLastRound=!1;constructor(){}update(t,i){let r=this.keys.length,o=[];if(t){for(let s=0;s<r;++s)o.push(1);this.lossesInARow=0}else{let s=i;for(let e=0;e<r;++e)if(s>this.columnsPerLevel[e])o[e]=1,s-=this.columnsPerLevel[e];else{o[e]=s/this.columnsPerLevel[e];break}}let n=o.length;for(let s=0;s<n;++s){let e=o[s],u=this.keys[s],h=f.getNode(u);if(e===1){if(!f.hasEdge(U,u))f.addDefaultEdge(U,u,[[u,1],[p,0]])}++h.visitedCount,h.sumPercentCompleted+=e,h.updateReward();let x=h.sumPercentCompleted/h.visitedCount,C=1-x;f.mapEdges((j)=>{if(j.tgt===u)j.probability[0][1]=x,j.probability[1][1]=C})}if(!t){++this.lossesInARow;for(let s=0;s<this.lossesInARow;++s){let e=f.getNode(U).neighbors,u=e.length;if(u===1)break;let h="",x=-1e4;for(let C=0;C<u;++C){let j=e[C],hi=f.getNode(j).depth;if(hi>x)h=j,x=hi}console.log("removing edge:",h,x),f.removeEdge(U,h)}}this.playerWonLastRound=t}get(t){let i=ti(f,0.95,!0,!0,20);if(this.columnsPerLevel=[],this.playerWonLastRound)this.keys=[Y(i[U])];else this.keys=[U];for(let n=0;n<t;++n){let s=Y(i[this.keys[n]]);if(this.keys.push(s),s===it)break}this.keys.splice(0,1),this.playerIsOnLastLevel=this.keys.includes(it);let r=Array(q).fill(""),o=this.keys.length;for(let n=0;n<o;++n){let s=Yi[this.keys[n]];this.columnsPerLevel.push(s[0].length);for(let e=0;e<q;++e)r[e]+=s[e]}return r}}class A{model;movingRight=!1;movingLeft=!1;jumping=!1}class ri extends A{time=0;name(){return"random"}update(t){if(this.time+=t,this.time>0.2)this.time=0,this.movingRight=B(),this.movingLeft=B(),this.jumping=B()}}class oi{queue=[];insert(t,i){if(this.queue.length==0){this.queue.push([t,i]);return}let r=0,o=this.queue.length,n;while(r<o)if(n=Math.floor((r+o)/2),t>=this.queue[n][0])o=n;else r=n+1;this.queue.splice(r,0,[t,i])}pop(){return this.queue.pop()[1]}length(){return this.queue.length}}class Wi{depth;model;action;pastNode;constructor(t,i,r,o=null){this.depth=t,this.model=i,this.action=r,this.pastNode=o}}function nr(t,i){let r=new oi;r.insert(0,new Wi(0,t,new Action(!1,!1,!1)));let o,n=0;while(r.length()>0){let s=r.pop();if(s.model.protaganist().pos.equals(i)){o=s;break}for(n=0;n<NUM_ACTIONS;++n){let e=ACTIONS[n]}}return[new Action(!0,!1,!0)]}class ni extends A{model;actions=[];coinIndex=0;time=0;constructor(t){super();this.model=t}name(){return"astar"}update(t){if(this.actions.length==0)this.actions=nr(this.model,this.model.coins[this.coinIndex]);if(this.time+=t,this.time>0.2){this.time=0;let i=this.actions.pop();this.movingRight=i.moveRight,this.movingLeft=i.moveLeft,this.jumping=i.jump}}}class Ut extends A{name(){return"player"}update(t){this.movingRight=b.isKeyDown(5,1),this.movingLeft=b.isKeyDown(4,0),this.jumping=b.isKeyDown(14,3)}}class si extends A{name(){return"empty"}update(t){}}class ei extends A{time=0;actions;constructor(t){super();this.actions=t}name(){return"deterministic"}update(t){if(this.time+=t,this.time>0.2)if(this.time=0,this.actions.length>0){let i=this.actions.pop();this.movingRight=i.moveRight,this.movingLeft=i.moveLeft,this.jumping=i.jump}else console.error("Actions array empty..."),this.movingRight=B(),this.movingLeft=B(),this.jumping=B()}}var sr=0,er=1,ui=2,ur=3,fr=4;function Ri(t,i){switch(t){case sr:return new ri;case er:return new ni(i);case ui:return new Ut;case ur:return new si;case fr:return console.warn("Deterministic agent did not receive a list of actions."),new ei([]);default:return console.error(`Unhandled agent type: ${t}. Defaulted to player agent.`),new Ut}}class st{game;pos;type;dead=!1;velocity=new d(0,0);gravity=new d(0,100);constructor(t,i){this.pos=t,this.type=i}physicsUpdate(t){jt(this.velocity,w(this.gravity,t)),this.velocity.y=Math.min(this.velocity.y,30),jt(this.pos,w(this.velocity,t))}}class y extends st{size;constructor(t,i,r){super(t,r);this.size=i}collision(t){if(t instanceof y){if(yi(this.pos,this.size,t.pos,t.size))this.handleCollision(t),t.handleCollision(this)}else if(t instanceof et){if(vt(this.pos,this.size,t.pos,t.r))this.handleCollision(t),t.handleCollision(this)}}}class et extends st{r;constructor(t,i,r){super(t,r);this.r=i}collision(t){if(t instanceof y){if(vt(t.pos,t.size,this.pos,this.r))this.handleCollision(t),t.handleCollision(this)}}}var D=0,X=1,kt=2,Z=3,Vt=4,N=5;class ut extends et{angle;start;constructor(t,i,r,o){super(t,ki,Z);this.gravity.y=0,this.angle=i,this.start=r,this.velocity=o}static defaultConstructor(t){return new ut(t,0,v(t),new d(0,0))}clone(){return new ut(v(this.pos),this.angle,this.start,v(this.velocity))}update(t){this.angle+=t,this.velocity.x=2*Wt*Math.cos(this.angle),this.velocity.y=Wt*Math.sin(this.angle)}handleCollision(t){this.dead=t.type===N}render(t,i){t.fillStyle=g,t.beginPath(),t.arc(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),Yt,0,qi),t.fill()}}class ft extends y{constructor(t,i){super(t,Bi,N);this.gravity.y=0,this.velocity=i}static defaultConstructor(t,i){let r=P(i,t);return li(r),mi(r,Ni),new ft(t,r)}clone(){return new ft(v(this.pos),v(this.velocity))}update(t){}handleCollision(t){this.dead=!0}render(t,i){t.fillStyle=g,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),Ci,ji)}}class At extends y{playerPos;color;time;state;constructor(t,i=0,r=0){super(t,K,X);this.color=F,this.gravity.y=0,this.time=i,this.state=r}clone(){return new At(v(this.pos),this.time,this.state)}update(t){switch(this.state){case 0:{if(bt(this.pos,this.game.protaganist().pos)<=Zi)this.color=g,this.state=1;break}case 1:{if(this.time+=t,this.time>=Pi)this.time=0,this.state=2;break}case 2:{this.state=0,this.color=F;let i=this.game.protaganist().pos,r=Bt(this.pos,i),o=Math.cos(r),n=Math.sin(r);this.game.dynamicEntities.push(ft.defaultConstructor(new d(this.pos.x+(qt+R)*o,this.pos.y+(qt+R)*n),i));break}default:{console.error(`Should not be able to enter state ${this.state}`),this.state=0;break}}}handleCollision(t){}render(t,i){t.strokeStyle=this.color;let r=i.columnToScreen(this.pos.x),o=i.rowToScreen(this.pos.y),n=J/2,s=2*n,e=new d(r+n,o);t.lineWidth=2,t.beginPath(),t.arc(e.x,e.y,n,0,Math.PI),t.stroke();let u=Bt(this.pos,this.game.protaganist().pos),h=Math.cos(u),x=Math.sin(u);t.lineWidth=4,t.beginPath(),t.moveTo(e.x+n*h,e.y+n*x),t.lineTo(e.x+s*h,e.y+s*x),t.stroke(),t.lineWidth=1}}class Pt extends y{constructor(t){super(t,K,X)}clone(){return new Pt(this.pos)}update(t){}handleCollision(t){}render(t,i){t.strokeStyle=O,t.strokeRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),J,W)}}var hr=1000,dr=2;class ht extends y{minY;maxY;yMod;timeGone;constructor(t,i,r,o,n,s){super(t,$t,Vt);this.gravity.y=0,this.yMod=i,this.minY=r,this.maxY=o,this.velocity.y=n,this.timeGone=s}static defaultConstructor(t){let i=Math.random()*0.5;return M(t,0.25),new ht(t,i,t.y+0.15,t.y+0.3,i,0)}clone(){return new ht(v(this.pos),this.yMod,this.minY,this.maxY,this.velocity.y,this.timeGone)}update(t){if(this.pos.y>100){if(this.timeGone+=t,this.timeGone>=dr)this.pos.y=this.maxY,this.velocity.y=-this.yMod}else if(this.pos.y>=this.maxY)this.velocity.y=-this.yMod;else if(this.pos.y<=this.minY)this.velocity.y=this.yMod}handleCollision(t){if(t.type===D)this.pos.y=hr,this.timeGone=0}render(t,i){t.fillStyle=wi,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),H,T)}}class dt extends y{minY;maxY;yMod;constructor(t,i,r,o,n){super(t,$t,kt);this.gravity.y=0,this.yMod=i,this.maxY=r,this.minY=o,this.velocity.y=n}static defaultConstructor(t){let i=Math.random()*0.5;return M(t,0.25),new dt(t,Math.random()*0.5,t.y+0.3,t.y+0.15,i)}clone(){return new dt(v(this.pos),this.yMod,this.maxY,this.minY,this.velocity.y)}update(t){if(this.pos.y>=this.maxY)this.velocity.y=-this.yMod;else if(this.pos.y<=this.minY)this.velocity.y=this.yMod}handleCollision(t){if(t.type===D)ai(),this.dead=!0}render(t,i){t.fillStyle=F,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),H,T)}}class mt extends y{maxColumns;constructor(t,i,r){super(t,Xi,Z);this.maxColumns=i,this.velocity.x=r,this.gravity.y=0}static defaultConstructor(t,i){return M(t,0.25),new mt(t,i,3)}clone(){return new mt(v(this.pos),this.maxColumns,this.velocity.x)}update(t){this.velocity.x*=xt(this.pos.x>=0&&this.pos.x<=this.maxColumns)}handleCollision(t){if(t.type===X){let i=P(z(this.pos,w(this.size,0.5)),z(t.pos,w(t.size,0.5))),r=z(this.size,t.size);if(w(r,0.5),Math.abs(i.x/this.size.x)>Math.abs(i.y/this.size.y))if(this.velocity.x*=-1,i.x<0)this.pos.x=t.pos.x-this.size.x;else this.pos.x=t.pos.x+t.size.x}else if(t.type===N)this.dead=!0}render(t,i){t.fillStyle=g,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),E,tt)}}class pt extends y{time;constructor(t,i,r){super(t,i,Z);this.gravity.y=0,this.time=r}static defaultConstructor(t,i){return t.x+=(R-Rt)/2,new pt(t,new d(Rt,i),0)}clone(){return new pt(this.pos,this.size,this.time)}update(t){gi(),this.time+=t,this.dead=this.time>=Ft}handleCollision(t){}render(t,i){t.fillStyle=g,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),Vi,this.size.y*l)}}class Zt extends y{color;time=0;state=0;constructor(t,i=0,r=0){super(t,K,X);this.color=F,this.gravity.y=0,this.state=i,this.time=r}clone(){return new Zt(v(this.pos),this.state,this.time)}update(t){if(bt(this.pos,this.game.protaganist().pos)>150)this.state=0;switch(this.time+=t,this.state){case 0:{if(this.time>=Ft)this.time=0,this.state=1,this.color=F;break}case 1:{if(this.time>=Ai){this.time=0,this.state=0,this.color=g;let i=this.game.raycastUp(this.pos),r=i===null?q:this.pos.y-i.pos.y-1;this.game.dynamicEntities.push(pt.defaultConstructor(new d(this.pos.x,this.pos.y-r),r))}break}default:{console.error(`Should not be able to enter state ${this.state}`),this.state=0;break}}}handleCollision(t){}render(t,i){t.strokeStyle=this.color;let r=i.columnToScreen(this.pos.x),o=i.rowToScreen(this.pos.y),n=o+W;t.beginPath(),t.moveTo(r,n),t.lineTo(r+J/2,o),t.lineTo(r+J,n),t.lineTo(r,n),t.stroke(),t.strokeStyle=O,t.beginPath(),t.moveTo(r,o),t.lineTo(r+J,o),t.stroke()}}var Mi=6,Ii=8,mr=0.4;class Nt extends y{movingRight;movingLeft;moveMod;jumpTime;squash;stretch;coinsCollected;maxColumn;agent;constructor(t,i,r=!1,o=!1,n=0,s=0,e=1,u=1,h=0,x=0){super(t,zi,D);this.agent=i,this.movingRight=r,this.movingLeft=o,this.moveMod=n,this.jumpTime=s,this.squash=e,this.stretch=u,this.coinsCollected=h,this.maxColumn=x}clone(){return new Nt(v(this.pos),this.agent,this.movingRight,this.movingLeft,this.moveMod,this.jumpTime,this.squash,this.stretch,this.coinsCollected,this.maxColumn)}update(t){if(this.pos.y>$i){this.dead=!0;return}if(this.velocity.x=0,this.agent.update(t),this.agent.movingRight)this.movingRight=!0,this.velocity.x=Mi,this.moveMod=Math.min(Ii,this.moveMod+t);if(this.agent.movingLeft)if(this.movingRight)this.movingRight=!1,this.velocity.x=0;else this.movingLeft=!0,this.velocity.x=-Mi,this.moveMod=Math.min(Ii,this.moveMod+t);if(this.jumpTime<mr&&this.agent.jumping){if(this.jumpTime===0)this.velocity.y=-15;else if(this.jumpTime<0.2)this.velocity.y-=2;this.velocity.y=Math.max(-20,this.velocity.y),this.squash=Math.min(1.03,this.squash+0.01),this.stretch=Math.max(0.97,this.stretch-0.01),this.jumpTime+=t}else if(this.squash!=this.stretch)this.squash+=0.01,this.stretch-=0.01;this.maxColumn=Math.max(this.pos.x,this.maxColumn)}handleCollision(t){switch(t.type){case X:{let i=t,r=P(z(this.pos,w(this.size,0.5)),z(i.pos,w(i.size,0.5))),o=z(this.size,i.size);w(o,0.5);let n=Math.abs(Math.atan(r.y/r.x));if(!(n<0.96&&n>0.698)&&Math.abs(r.x/this.size.x)>Math.abs(r.y/this.size.y))if(r.x<0)this.pos.x=i.pos.x-this.size.x;else this.pos.x=i.pos.x+i.size.x;else if(r.y>0)this.pos.y=i.pos.y+i.size.y;else this.pos.y=i.pos.y-this.size.y,this.velocity.y=0,this.jumpTime=0,this.stretch=1.01,this.squash=0.99;break}case kt:{++this.coinsCollected;break}case N:case Z:{this.dead=!0;break}case Vt:{this.jumpTime=0,this.velocity.y=Math.min(this.velocity.y,0);break}default:{console.warn(`Player unhandled collision type: ${t.type}.`);break}}}render(t,i){t.fillStyle=at;let r=i.columnToScreen(this.pos.x),o=i.rowToScreen(this.pos.y),n=G*this.squash,s=_*this.stretch;if(this.movingRight){let e=new Path2D;e.moveTo(r,o),e.lineTo(r-this.moveMod,o+n),e.lineTo(r+s-this.moveMod,o+n),e.lineTo(r+s,o),e.closePath(),t.fill(e,"evenodd"),this.movingRight=!1}else if(this.movingLeft){let e=new Path2D;e.moveTo(r,o),e.lineTo(r+this.moveMod,o+n),e.lineTo(r+s+this.moveMod,o+n),e.lineTo(r+s,o),e.closePath(),t.fill(e,"evenodd"),this.movingLeft=!1}else t.fillRect(r,o,s,n)}}class lt extends y{constructor(t,i){super(t,Ui,Z);this.velocity.y=i,this.gravity.y=0}static defaultConstructor(t){return t.x+=0.25,t.y+=0.1,new lt(t,3)}clone(){return new lt(v(this.pos),this.velocity.y)}update(t){this.velocity.y*=xt(this.pos.y>0&&this.pos.y<=q)}handleCollision(t){if(t.type===X){let i=P(z(this.pos,w(this.size,0.5)),z(t.pos,w(t.size,0.5))),r=z(this.size,t.size);if(w(r,0.5),Math.abs(i.x/this.size.x)<Math.abs(i.y/this.size.y))if(this.velocity.y*=-1,i.y>0)this.pos.y=t.pos.y+t.size.y;else this.pos.y=t.pos.y-this.size.y}else if(t.type===N)this.dead=!0}render(t,i){t.fillStyle=g,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),tt,E)}}class Ct{staticEntities=[];dynamicEntities=[];coins=[];numColumns;constructor(t,i){if(t===null)return;let r=t.length;if(r!==q){console.error("Level should have 15 rows!");return}this.dynamicEntities.push(new Nt(new d(2,12),Ri(i,this)));let o=t[0].length;this.numColumns=o;for(let s=0;s<r;++s){let e=t[s];if(o!==e.length){console.error(`Every row in the level should have the same number of columns! (${o} !== ${e.length}).`);return}for(let u=0;u<o;++u){let h=e[u];if(h==="X")this.staticEntities.push(new Pt(new d(u,s)));else if(h==="^")this.dynamicEntities.push(new Zt(new d(u,s)));else if(h==="T")this.dynamicEntities.push(new At(new d(u,s)));else if(h==="o")this.coins.push(new d(u,s)),this.dynamicEntities.push(dt.defaultConstructor(new d(u,s)));else if(h=="b")this.dynamicEntities.push(ht.defaultConstructor(new d(u,s)));else if(h==="H")this.dynamicEntities.push(mt.defaultConstructor(new d(u,s),o));else if(h==="V")this.dynamicEntities.push(lt.defaultConstructor(new d(u,s)));else if(h==="C")this.dynamicEntities.push(ut.defaultConstructor(new d(u,s)));else if(h!=="-")console.error(`Unhandled tile type: ${e[u]}`)}}let n=0;for(;n<this.staticEntities.length;++n)this.staticEntities[n].game=this;for(let s=0;s<this.dynamicEntities.length;++s)this.dynamicEntities[s].game=this}clone(){let t=new Ct(null,0),i=this.dynamicEntities.length,r=0;for(;r<i;++r){let n=this.dynamicEntities[r].clone();n.game=t,this.dynamicEntities.push(n)}let o=this.staticEntities.length;for(r=0;r<o;++r){let n=this.staticEntities[r].clone();n.game=t,t.staticEntities.push(n)}return t.coins=this.coins,t}update(t){let i=this.dynamicEntities.length,r=this.staticEntities.length,o,n=0;for(;n<i;++n){let s=this.dynamicEntities[n];if(s.update(t),s.dead){if(n==0)break;this.dynamicEntities.splice(n,1),--n,--i}s.physicsUpdate(t);for(o=n+1;o<i;++o)s.collision(this.dynamicEntities[o]);for(o=0;o<r;++o)s.collision(this.staticEntities[o])}}render(t,i){i.update(this.dynamicEntities[0].pos.x);let r=this.staticEntities.length,o=0;for(;o<r;++o)this.staticEntities[o].render(t,i);r=this.dynamicEntities.length;for(o=0;o<r;++o)this.dynamicEntities[o].render(t,i)}state(){let t=this.dynamicEntities[0];if(t.coinsCollected>=this.coins.length)return ct;if(t.dead)return wt;return gt}protaganist(){return this.dynamicEntities[0]}fitness(){return 1-this.dynamicEntities[0].coinsCollected/this.coins.length}raycastUp(t){let i=v(t);i.y-=1;let r=this.staticEntities.length,o;while(i.y>=0){for(o=0;o<r;++o){let n=this.staticEntities[o];if(di(i,n.pos))return n}i.y-=1}return null}}class fi extends k{ctx;transitionScene;agentType;game;camera;levelDirector;constructor(t,i,r){super();this.ctx=t,this.agentType=r,this.transitionScene=i,this.camera=new Tt,this.levelDirector=new ii}onEnter(){let t=this.levelDirector.get(Fi);this.game=new Ct(t,this.agentType)}update(t){this.game.update(t);let i=this.game.state();switch(i){case gt:break;case wt:{this.transitionScene.targetScene=Qt,this.changeScene=V;break}case ct:{if(this.levelDirector.playerIsOnLastLevel)this.transitionScene.targetScene=zt;else this.transitionScene.targetScene=ot;this.changeScene=V;break}default:{console.error(`Unhandled game state type: ${i}`);break}}}render(){this.ctx.clearRect(0,0,c,Q),this.game.render(this.ctx,this.camera)}_onExit(){let t=this.game.fitness();console.log(`Fitness: ${t}`),this.levelDirector.update(this.transitionScene.targetScene===ot,t)}}window.addEventListener("load",()=>{vi(()=>{b.init();let t=document.createElement("canvas");t.setAttribute("id","canvas"),t.width=c,t.height=Q;let i=t.getContext("2d");document.getElementById("game").appendChild(t);let r=new St,o=new Kt(i);r.registerScene(V,o),r.registerScene(rt,new Ht(i,o)),r.registerScene(S,new fi(i,o,ui)),r.registerScene(zt,new Mt(i)),r.registerScene(ot,new It(i,o)),r.registerScene(Qt,new Ot(i,o));let n=r.getScene(rt);n.onEnter();let s=0,e=(u)=>{let h=Math.min(0.05,(u-s)/1000);s=u,n.update(yt(h,0.01,0.2)),n.render();let x=n.changeScene;if(x!==void 0)n.onExit(),n=r.getScene(x),n.onEnter();window.requestAnimationFrame(e)};window.requestAnimationFrame(e)})});
