class p{x;y;constructor(t,i){this.x=t,this.y=i}}function v(t){return new p(t.x,t.y)}function yi(t,i){return t.x==i.x&&t.y==i.y}function z(t,i){return new p(t.x+i.x,t.y+i.y)}function At(t,i){t.x+=i.x,t.y+=i.y}function a(t,i){return new p(t.x-i.x,t.y-i.y)}function wt(t,i){t.x+=i,t.y+=i}function F(t,i){return new p(t.x*i,t.y*i)}function li(t,i){t.x*=i,t.y*=i}function vi(t){return t.x*t.x+t.y*t.y}function Ei(t){return Math.sqrt(t.x*t.x+t.y*t.y)}function xi(t){let i=Ei(t);t.x/=i,t.y/=i}function O(t,i){let r=t.x-i.x,n=t.y-i.y;return r*r+n*n}function wi(t,i){return console.log(`(${S(t)}) -> ${S(i)} = ${Math.sqrt(O(t,i))}`),Math.sqrt(O(t,i))}function Ot(t,i){return Math.atan2(i.y-t.y,i.x-t.x)}function S(t){return`${t.x},${t.y}`}function gi(t,i){return Math.floor(Math.random()*(i-t+1)+t)}function $t(t){return t*2-1}function Ft(){return Math.random()<0.5}function gt(t,i,r){return Math.min(Math.max(t,i),r)}function qt(t,i,r,n){return vi(a(r,new p(gt(r.x,t.x,t.x+i.x),gt(r.y,t.y,t.y+i.y))))<n*n}function $i(t,i,r,n){let{x:o,y:s}=t,f=o+i.x,u=s+i.y,e=r.x,b=r.y,V=e+n.x,g=b+n.y;return o<V&&f>e&&s<g&&u>b}function Fi(t){let i=Object.keys(t);return i[Math.floor(Math.random()*i.length)]}var qi=typeof window!=="undefined",q=[];function zi(t){q.push(new Audio("audio/coin_1.wav")),q.push(new Audio("audio/coin_2.wav")),q.push(new Audio("audio/coin_3.wav")),q.push(new Audio("audio/coin_4.wav")),q.push(new Audio("audio/coin_5.wav")),q.push(new Audio("audio/laser.wav"));let i=()=>{let r=!0;for(let n=0;n<q.length;++n)if(!q[n].readyState){r=!1;break}if(r)q[5].volume=0.4,t();else setTimeout(i,100)};i()}function Qi(){if(qi){let t=gi(0,4);q[t].currentTime=0.15,q[t].play()}}function Ji(){if(qi)q[5].currentTime=0,q[5].play()}var I;((m)=>{m[m.LEFT=0]="LEFT";m[m.RIGHT=1]="RIGHT";m[m.DOWN=2]="DOWN";m[m.UP=3]="UP";m[m.A=4]="A";m[m.D=5]="D";m[m.E=6]="E";m[m.G=7]="G";m[m.H=8]="H";m[m.I=9]="I";m[m.Q=10]="Q";m[m.R=11]="R";m[m.S=12]="S";m[m.W=13]="W";m[m.SPACE=14]="SPACE";m[m.ESCAPE=15]="ESCAPE";m[m.ENTER=16]="ENTER";m[m.SHIFT=17]="SHIFT";m[m.INVALID=18]="INVALID"})(I||={});class y{static _keys=[];static init(){for(let t=0;t<Object.keys(I).length;++t)y._keys.push(!1);window.addEventListener("keydown",y.onKeyDown),window.addEventListener("keyup",y.onKeyUp)}static isKeyDown(...t){let i=t.length;for(let r=0;r<i;++r)if(y._keys[t[r]])return!0;return!1}static keyStrToKey(t){switch(t){case"Down":case"ArrowDown":return 2;case"Up":case"ArrowUp":return 3;case"Right":case"ArrowRight":return 1;case"Left":case"ArrowLeft":return 0;case" ":case"Space":return 14;case"Escape":return 15;case"a":case"A":return 4;case"e":case"E":return 6;case"s":case"S":return 12;case"d":case"D":return 5;case"w":case"W":return 13;case"r":case"R":return 11;case"q":case"Q":return 10;case"g":case"G":return 7;case"h":case"H":return 8;case"i":case"I":return 9;case"Shift":return 17;case"Enter":return 16;default:return console.warn(`Unhandled key: ${t}.`),18}}static onKeyDown(t){let i=y.keyStrToKey(t.key);if(y._keys[i]=!0,i==2||i==3||i==0||i==1)t.preventDefault();return!1}static onKeyUp(t){return y._keys[y.keyStrToKey(t.key)]=!1,!1}static clear(){for(let t=0;t<y._keys.length;++t)y._keys[t]=!1}}class St{scenes={};registerScene(t,i){if(this.scenes[t]===void 0)this.scenes[t]=i;else console.error(`Key "${t}" for scene already exists! Scene not added to SceneManager.`)}getScene(t){return this.scenes[t]}}var $="#fe546f";var Q="#ffd080",K="#fffdff",Ui="#0bffe6";var ki="#9696ff";var J=720,U=480,x=32,c=15,Vi=c+2,Xi=3,Pi=2*Math.PI,G=0,zt=1,Qt=2,It=20,Kt=30,tr=It/x,ir=Kt/x,Zi=new p(tr,ir),C=31,tt=31,W=C/x,rr=tt/x,H=new p(W,rr),M=16,L=16,nr=M/x,or=L/x,Jt=new p(nr,or),it=25,rt=15,ai=it/x,ci=rt/x,Ci=new p(ai,ci),Bi=new p(ci,ai),Gt=10,Yi=Gt/x,Ht=2.5,Mt=W/8,Ri=C/8,Ut=0.6,ji=2,Ni=2.5,Wi=150,Ai=10,Oi=10,Si=10,kt=M/x,sr=L/x,Ii=new p(kt,sr),X="start",nt="end",d="death";class P{changeScene;onExit(){this.changeScene=void 0,this._onExit()}}class Lt extends P{ctx;constructor(t){super();this.ctx=t}onEnter(){this.ctx.clearRect(0,0,J,U),this.ctx.font="30px Arial",this.ctx.fillStyle=K,this.ctx.fillText("You won! Congratulations!",170,U/2)}update(t){}render(){}_onExit(){}}var ot="main menu",j="game",Vt="player won",Z="transition",Xt="lost",st="won";class Tt extends P{ctx;transitionScene;constructor(t,i){super();this.ctx=t,this.transitionScene=i}onEnter(){y.clear(),this.ctx.fillStyle=Q,this.ctx.font="48px Arial",this.ctx.fillText("YOU WON",250,200),this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to keep going.",180,400)}update(t){if(y.isKeyDown(14))this.transitionScene.targetScene=j,this.changeScene=Z}render(){}_onExit(){}}class Dt extends P{ctx;transitionScene;constructor(t,i){super();this.ctx=t,this.transitionScene=i}onEnter(){y.clear(),this.ctx.fillStyle=$,this.ctx.font="48px Arial",this.ctx.fillText("YOU LOST",243,200),this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to try again.",195,400)}update(t){if(y.isKeyDown(14))this.transitionScene.targetScene=j,this.changeScene=Z}render(){}_onExit(){}}class _t{changeScene;onExit(){this.changeScene=void 0,this._onExit()}}class Et extends _t{targetScene=ot;timer=0;ctx;constructor(t){super();this.ctx=t}onEnter(){}update(t){if(this.timer+=t,this.timer>0.5)this.changeScene=this.targetScene}render(){let t=this.timer/0.5;this.ctx.fillStyle=`rgba(0,0,0, ${t})`,this.ctx.fillRect(0,0,J,U)}_onExit(){this.timer=0}}class R{movingRight=!1;movingLeft=!1;jumping=!1;set(t){this.movingRight=t.moveRight,this.movingLeft=t.moveLeft,this.jumping=t.jump}}class ti extends R{time=0;name(){return"random"}update(t){if(this.time+=t,this.time>0.2)this.time=0,this.movingRight=Ft(),this.movingLeft=Ft(),this.jumping=Ft()}}class Pt extends R{name(){return"player"}update(t){this.movingRight=y.isKeyDown(5,1),this.movingLeft=y.isKeyDown(4,0),this.jumping=y.isKeyDown(14,3)}}class Zt extends R{name(){return"empty"}update(t){}}class ft extends R{time=0;actions;constructor(t){super();this.actions=t}j;name(){return"deterministic"}update(t){if(this.time+=t,this.actions.length>0){let i=this.actions.pop();if(this.movingRight=i.moveRight,this.movingLeft=i.moveLeft,this.jumping=i.jump,this.actions.length<=0)console.error("Ran out of actions :/")}else this.movingLeft=!0,this.jumping=!0}}var ii=0,ri=1,ni=2,ur=3,er=4;function Ki(t,i){switch(t){case ii:return new ti;case ri:return new Zt;case ni:return new Pt;case ur:return new Zt;case er:return console.warn("Deterministic agent did not receive a list of actions."),new ft([]);default:return console.error(`Unhandled agent type: ${t}. Defaulted to player agent.`),new Pt}}class oi{src;tgt;probability;constructor(t,i,r){this.src=t,this.tgt=i,this.probability=r}}class ut{name;reward;utility;isTerminal;neighbors;constructor(t,i,r,n,o){this.name=t,this.reward=i,this.utility=r,this.isTerminal=n,this.neighbors=o}}class at{nodes;edges;constructor(){this.nodes={},this.edges={}}getNode(t){return this.nodes[t]}hasNode(t){return t in this.nodes}addNode(t){this.nodes[t.name]=t}addDefaultNode(t,i=1,r=0,n=!1,o=null){if(o==null)o=[];this.nodes[t]=new ut(t,i,r,n,o)}removeNode(t){let i=[];for(let r of Object.values(this.edges)){if(r.src==t||r.tgt==t)i.push(r);let n=r.probability,o=-1;for(let e=0;e<n.length;e++){let[b,V]=n[e];if(b==t){o=e;break}}if(o==-1)continue;let s=n[o][1];n.splice(o,1);let f=n.length,u=s/f;r.probability=n.map(([e,b])=>[e,b+u])}for(let r of i)this.removeEdge(r.src,r.tgt);delete this.nodes[t]}getEdge(t,i){return this.edges[`${t},${i}`]}hasEdge(t,i){return`${t},${i}`in this.edges}addEdge(t){this.edges[`${t.src},${t.tgt}`]=t;let i=this.nodes[t.src].neighbors;if(!i.includes(t.tgt))i.push(t.tgt)}addDefaultEdge(t,i,r=null){if(r==null)r=[[i,1]];this.addEdge(new oi(t,i,r))}removeEdge(t,i){let r=this.nodes[t],n=r.neighbors.indexOf(i);r.neighbors.splice(n,1),delete this.edges[`${t},${i}`]}neighbors(t){return this.nodes[t].neighbors}setNodeUtilities(t){for(let[i,r]of Object.entries(t))this.nodes[i].utility=r}utility(t){return this.nodes[t].utility}reward(t){return this.nodes[t].reward}isTerminal(t){return this.nodes[t].isTerminal}mapNodes(t){for(let i of Object.values(this.nodes))t(i)}mapEdges(t){for(let i of Object.values(this.edges))t(i)}}function N(t){return t[Math.floor(Math.random()*t.length)]}function T(t,i,r,n){let o=t.getEdge(i,r).probability,s=o.length,f=0;for(let u=0;u<s;++u){let[e,b]=o[u];f+=b*(t.reward(e)+n*t.utility(e))}return f}function ct(t,i,r){let n=t.getNode(i);if(n.isTerminal)return 0;let o=n.neighbors,s=o.length,f=-1/0;for(let u=0;u<s;++u)f=Math.max(f,T(t,i,o[u],r));return f}function si(t){for(let i in t.nodes)t.nodes[i].utility=0}function fi(t){let i={};for(let r in t.nodes)if(!t.getNode(r).isTerminal)i[r]=[...t.neighbors(r)];return i}function ui(t,i){let r={};for(let n in t.nodes){if(t.getNode(n).isTerminal)continue;let o=-1/0,s=[];for(let f of t.neighbors(n)){let u=T(t,n,f,i);if(u===o)s.push(f);else if(u>o)o=u,s.length=0,s.push(f)}r[n]=s}return r}function hr(t,i,r,n){for(let o=0;o<n;++o)for(let s in t.nodes){let f=t.getNode(s);if(!f.isTerminal)f.utility=T(t,s,N(i[s]),r)}}function mr(t,i,r,n){for(let o=0;o<n;++o){let s={};for(let f in t.nodes)if(!t.getNode(f).isTerminal)s[f]=T(t,f,N(i[f]),r);t.setNodeUtilities(s)}}function pr(t,i,r,n){for(let o=0;o<n;++o)for(let s in t.nodes)t.getNode(s).utility=ct(t,s,r)}function dr(t,i,r,n){for(let o=0;o<n;++o){let s={};for(let f in t.nodes)s[f]=ct(t,f,r);t.setNodeUtilities(s)}}function Gi(t,i,r){let n=!1;for(let o in t.nodes){if(t.getNode(o).isTerminal)continue;let s=null,f=-1/0;for(let u of t.neighbors(o)){let e=T(t,o,u,r);if(e===f);else if(e>f)s=u,f=e}if(N(i[o])!==s)i[o].length=0,i[o].push(s),n=!0}return n}function ei(t,i,r=!1,n=!1,o=10,s=!0){if(s)si(t);let f=fi(t),u;if(r&&n)u=hr;else if(r&&!n)u=mr;else if(!r&&n)u=pr;else u=dr;let e=!0;while(e)u(t,f,i,o),e=Gi(t,f,i);return u(t,f,i,o),Gi(t,f,i),ui(t,i)}class w extends ut{visitedCount;sumPercentCompleted;depth;designerReward;playerReward;constructor(t,i,r,n,o,s){super(t,i,r,n,o);this.designerReward=i,this.playerReward=0,this.depth=s,this.visitedCount=1,this.sumPercentCompleted=1}updateReward(){this.reward=this.designerReward*this.visitedCount}}var h=new at;h.addNode(new w(X,0,0,!1,[],-1));h.addNode(new w(d,-1,0,!0,[],-1));h.addNode(new w(nt,1,0,!0,[],-1));h.addNode(new w("1-a",-0.95,0,!1,[],1));h.addNode(new w("2-a",-0.925,0,!1,[],2));h.addNode(new w("2-b",-0.925,0,!1,[],2));h.addNode(new w("3-a",-0.9,0,!1,[],3));h.addNode(new w("3-b",-0.9,0,!1,[],3));h.addNode(new w("4-a",-0.825,0,!1,[],4));h.addNode(new w("4-b",-0.825,0,!1,[],4));h.addNode(new w("5-a",-0.8,0,!1,[],5));h.addNode(new w("5-b",-0.8,0,!1,[],5));h.addNode(new w("5-c",-0.8,0,!1,[],5));h.addNode(new w("6-a",-0.775,0,!1,[],6));h.addNode(new w("7-a",-0.75,0,!1,[],7));h.addNode(new w("6-b",-0.775,0,!1,[],6));h.addNode(new w("1-b",-0.95,0,!1,[],1));h.addDefaultEdge(X,"1-a",[["1-a",0.99],[d,0.01]]);h.addDefaultEdge("1-a","2-b",[["2-b",0.99],[d,0.01]]);h.addDefaultEdge("1-a","2-a",[["2-a",0.99],[d,0.01]]);h.addDefaultEdge("2-a","3-a",[["3-a",0.99],[d,0.01]]);h.addDefaultEdge("2-b","3-b",[["3-b",0.99],[d,0.01]]);h.addDefaultEdge("3-a","4-b",[["4-b",0.99],[d,0.01]]);h.addDefaultEdge("3-a","4-a",[["4-a",0.99],[d,0.01]]);h.addDefaultEdge("3-b","4-b",[["4-b",0.99],[d,0.01]]);h.addDefaultEdge("3-b","4-a",[["4-a",0.99],[d,0.01]]);h.addDefaultEdge("4-a","5-b",[["5-b",0.99],[d,0.01]]);h.addDefaultEdge("4-a","5-a",[["5-a",0.99],[d,0.01]]);h.addDefaultEdge("4-a","5-c",[["5-c",0.99],[d,0.01]]);h.addDefaultEdge("4-b","5-b",[["5-b",0.99],[d,0.01]]);h.addDefaultEdge("4-b","5-a",[["5-a",0.99],[d,0.01]]);h.addDefaultEdge("4-b","5-c",[["5-c",0.99],[d,0.01]]);h.addDefaultEdge("5-a","6-a",[["6-a",0.99],[d,0.01]]);h.addDefaultEdge("5-a","6-b",[["6-b",0.99],[d,0.01]]);h.addDefaultEdge("5-b","6-a",[["6-a",0.99],[d,0.01]]);h.addDefaultEdge("5-b","6-b",[["6-b",0.99],[d,0.01]]);h.addDefaultEdge("5-c","6-a",[["6-a",0.99],[d,0.01]]);h.addDefaultEdge("5-c","6-b",[["6-b",0.99],[d,0.01]]);h.addDefaultEdge("6-a","7-a",[["7-a",0.99],[d,0.01]]);h.addDefaultEdge("7-a","end",[["end",0.99],[d,0.01]]);h.addDefaultEdge("6-b","7-a",[["7-a",0.99],[d,0.01]]);h.addDefaultEdge(X,"1-b",[["1-b",0.99],[d,0.01]]);h.addDefaultEdge("1-b","2-b",[["2-b",0.99],[d,0.01]]);h.addDefaultEdge("1-b","2-a",[["2-a",0.99],[d,0.01]]);var D={"1-a":["------------XXX-","-------------T--","----------------","----------------","----------------","----------------","----------------","----------------","-----X-C-----X--","--------------b-","-----------o----","--------o-XX----","------o-XXXX----","------XXXXXX----","XXXXXXXXXXXX^XXX"],"2-a":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","-------XXXXXXXX-------","----------------------","-------V--o---V-----o-","----------------------","XXXXXXXXXXXXXXXXXXXXXX"],"2-b":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","-----------o----------","--------------------o-","-----X---H-----X------","XXXXXXXXXXXXXXXXXXXXXX"],"3-a":["----------------------","----------------------","----------------------","----------------------","-----------o----------","----------------------","---------XXXXX--------","-----------o----------","----------------------","-------X-H-----X------","---XX--XXXXXXXXX--XX--","----------------------","-------V---o---V----o-","----------------------","XXXXXXXXXXXXXXXXXXXXXX"],"3-b":["----------------------","----------------------","----------------------","----------------------","----------o-----------","----------------------","--------XXXXX---------","--------V---V---------","----------o-----------","----------------------","------XXXXXXXXX-------","----------------------","----------o---------o-","-----X---H-----X------","XXXXXXXXXXXXXXXXXXXXXX"],"4-a":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------XXX---","-----------------V----","-------X---XX-----V---","------XX------o-V---o-","-----XXX--------------","XXXXXXXX---XXXXXXXXXXX"],"4-b":["--------------------XX","--------------------XX","--------------------XX","--------------------XX","--------------------XX","-----------X-H---o--XX","-----------------o--XX","---------o----------XX","-----------XXXXXXX--XX","--------------------XX","-------X------------XX","------XXX-----------XX","-----XXXXX-----------o","----XXXXXXX-----------","XXXXXXXXXXXXXXXX--XXXX"],"5-a":["--------XXXXXXXXXXXXXX--------","-------------------ooX--------","---------------------X--------","---------------------X--------","------------------XXXX--------","------------------X-----------","-----------o--XXXXX-----------","------------------------------","---------XX-----------------o-","------------------------------","--------------XX---XXX----XXXX","------------------------------","----------XX------------------","------------------------------","XXXXXXXX----------------------"],"5-b":["------------------------------","-o----------------------------","------------------------------","XXX---------------------------","------------------------------","-----XXX----------------------","------------------------------","-----------XXX----------------","-o--------------------------o-","------XXX---------------------","XXX-----------------------XXXX","------------XXX-------XX------","------------------XX----------","------------------------------","XXXXXXXX---XXXXX--------------"],"5-c":["o-----------------------------","------------------------------","X---XX------------------------","------------------------------","------------------------------","XX----------------------------","--------XXXXX-----------------","--------Xoo-------------------","XXX-----Xoo----o------------o-","--------X---------------------","--------XXX---XX----XX----XXXX","XXXX--------------------------","------------------------------","------------------------------","XXXXXXXX----------------------"],"6-a":["----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","-------oo---XXXXXXXX----------","-o----------XXXXXXXX----------","------XXXX--XXXXXXXX----------","--------------o---------------","XXXX--------------------------","-------------XXXX-----------o-","---------------------XX-------","XXXXXXXX-----------------XXXXX"],"7-a":["-------------------V---------------","-----------------o---o-------------","------------X-H------------H--XXX--","-----V------XXXXXXXXXXXXXXXXXXXXX--","--------XX----o--------------------","-----------------------------------","-----------XXXXXX---Ho-------------","-----------------------------------","-------------V------XX--------H----","-----------------------------------","XX--------o------XXXXX----H--------","-----------------------------------","---X----H----H-X-----------------o-","---XXXXXXXXXXXXX-------------------","XXXX--------------------------XXXXX"],end:["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----oooooooooooooooooo","XXXXXXXXXXXXXXXXXXXXXX"],"6-b":["----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX--o-------","-o--------XXXXXXXXXX----------","----------XXXXXXXXXX--X-------","----------XXXXXXXXXX----------","XXX-------XXXXXXXXXXX---------","------XX-----oooo-----------o-","------------------------------","XXXX--------XXXXXX---XX---XXXX"],"1-b":["---------XXX----","----------T-----","----------------","----------------","----------------","----------------","----------------","----X-----X-----","-------oo------C","----------------","-------XX-------","----o-XXXX-o----","-----XXXXXX-----","---XXXXXXXXXX---","XXXXXXXXXXXXXXXX"]};class et{startCol=0;offsetX=0;colsPerScreen=Math.ceil(J/x);update(t){let i=t-this.colsPerScreen/2;this.startCol=Math.max(0,Math.floor(i)),this.offsetX=-i*x+this.startCol*x}columnToScreen(t){return(t-this.startCol)*x+this.offsetX}rowToScreen(t){return t*x}}class ht{game;pos;type;dead=!1;velocity=new p(0,0);gravity=new p(0,100);constructor(t,i){this.pos=t,this.type=i}physicsUpdate(t){At(this.velocity,F(this.gravity,t)),this.velocity.y=Math.min(this.velocity.y,30),At(this.pos,F(this.velocity,t))}}class l extends ht{size;constructor(t,i,r){super(t,r);this.size=i}collision(t){if(t instanceof l){if($i(this.pos,this.size,t.pos,t.size))this.handleCollision(t),t.handleCollision(this)}else if(t instanceof mt){if(qt(this.pos,this.size,t.pos,t.r))this.handleCollision(t),t.handleCollision(this)}}}class mt extends ht{r;constructor(t,i,r){super(t,r);this.r=i}collision(t){if(t instanceof l){if(qt(t.pos,t.size,this.pos,this.r))this.handleCollision(t),t.handleCollision(this)}}}var _=0,k=1,Ct=2,B=3,Bt=4,Y=5;class pt extends mt{angle;start;constructor(t,i,r,n){super(t,Yi,B);this.gravity.y=0,this.angle=i,this.start=r,this.velocity=n}static defaultConstructor(t){return new pt(t,0,v(t),new p(0,0))}clone(){return new pt(v(this.pos),this.angle,this.start,v(this.velocity))}update(t){this.angle+=t,this.velocity.x=2*Ht*Math.cos(this.angle),this.velocity.y=Ht*Math.sin(this.angle)}handleCollision(t){this.dead=t.type===Y}render(t,i){t.fillStyle=$,t.beginPath(),t.arc(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),Gt,0,Pi),t.fill()}}class dt extends l{constructor(t,i){super(t,Ii,Y);this.gravity.y=0,this.velocity=i}static defaultConstructor(t,i){let r=a(i,t);return xi(r),li(r,Ai),new dt(t,r)}clone(){return new dt(v(this.pos),v(this.velocity))}update(t){}handleCollision(t){this.dead=!0}render(t,i){t.fillStyle=$,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),Oi,Si)}}class Yt extends l{playerPos;color;time;state;constructor(t,i=0,r=0){super(t,H,k);this.color=Q,this.gravity.y=0,this.time=i,this.state=r}clone(){return new Yt(v(this.pos),this.time,this.state)}update(t){switch(this.state){case 0:{if(O(this.pos,this.game.protaganist().pos)<=Wi)this.color=$,this.state=1;break}case 1:{if(this.time+=t,this.time>=Ni)this.time=0,this.state=2;break}case 2:{this.state=0,this.color=Q;let i=this.game.protaganist().pos,r=Ot(this.pos,i),n=Math.cos(r),o=Math.sin(r);this.game.dynamicEntities.push(dt.defaultConstructor(new p(this.pos.x+(kt+W)*n,this.pos.y+(kt+W)*o),i));break}default:{console.error(`Should not be able to enter state ${this.state}`),this.state=0;break}}}handleCollision(t){}render(t,i){t.strokeStyle=this.color;let r=i.columnToScreen(this.pos.x),n=i.rowToScreen(this.pos.y),o=C/2,s=2*o,f=new p(r+o,n);t.lineWidth=2,t.beginPath(),t.arc(f.x,f.y,o,0,Math.PI),t.stroke();let u=Ot(this.pos,this.game.protaganist().pos),e=Math.cos(u),b=Math.sin(u);t.lineWidth=4,t.beginPath(),t.moveTo(f.x+o*e,f.y+o*b),t.lineTo(f.x+s*e,f.y+s*b),t.stroke(),t.lineWidth=1}}class Rt extends l{constructor(t){super(t,H,k)}clone(){return new Rt(this.pos)}update(t){}handleCollision(t){}render(t,i){t.lineWidth=1.3,t.strokeStyle=K,t.strokeRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),C,tt)}}var br=1000,yr=2;class bt extends l{minY;maxY;yMod;timeGone;constructor(t,i,r,n,o,s){super(t,Jt,Bt);this.gravity.y=0,this.yMod=i,this.minY=r,this.maxY=n,this.velocity.y=o,this.timeGone=s}static defaultConstructor(t){let i=Math.random()*0.5;return wt(t,0.25),new bt(t,i,t.y+0.15,t.y+0.3,i,0)}clone(){return new bt(v(this.pos),this.yMod,this.minY,this.maxY,this.velocity.y,this.timeGone)}update(t){if(this.pos.y>100){if(this.timeGone+=t,this.timeGone>=yr)this.pos.y=this.maxY,this.velocity.y=-this.yMod}else if(this.pos.y>=this.maxY)this.velocity.y=-this.yMod;else if(this.pos.y<=this.minY)this.velocity.y=this.yMod}handleCollision(t){if(t.type===_)this.pos.y=br,this.timeGone=0}render(t,i){t.fillStyle=Ui,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),M,L)}}class yt extends l{minY;maxY;yMod;constructor(t,i,r,n,o){super(t,Jt,Ct);this.gravity.y=0,this.yMod=i,this.maxY=r,this.minY=n,this.velocity.y=o}static defaultConstructor(t){let i=Math.random()*0.5;return t.x+=0.25,t.y-=0.25,new yt(t,Math.random()*0.5,t.y+0.3,t.y+0.15,i)}clone(){return new yt(v(this.pos),this.yMod,this.maxY,this.minY,this.velocity.y)}update(t){if(this.pos.y>=this.maxY)this.velocity.y=-this.yMod;else if(this.pos.y<=this.minY)this.velocity.y=this.yMod}handleCollision(t){if(t.type===_)Qi(),this.dead=!0}render(t,i){t.fillStyle=Q,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),M,L)}}class lt extends l{maxColumns;constructor(t,i,r){super(t,Ci,B);this.maxColumns=i,this.velocity.x=r,this.gravity.y=0}static defaultConstructor(t,i){return wt(t,0.25),new lt(t,i,3)}clone(){return new lt(v(this.pos),this.maxColumns,this.velocity.x)}update(t){this.velocity.x*=$t(this.pos.x>=0&&this.pos.x<=this.maxColumns)}handleCollision(t){if(t.type===k){let i=a(z(this.pos,F(this.size,0.5)),z(t.pos,F(t.size,0.5))),r=z(this.size,t.size);if(F(r,0.5),Math.abs(i.x/this.size.x)>Math.abs(i.y/this.size.y))if(this.velocity.x*=-1,i.x<0)this.pos.x=t.pos.x-this.size.x;else this.pos.x=t.pos.x+t.size.x}else if(t.type===Y)this.dead=!0}render(t,i){t.fillStyle=$,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),it,rt)}}class vt extends l{time;constructor(t,i,r){super(t,i,B);this.gravity.y=0,this.time=r}static defaultConstructor(t,i){return t.x+=(W-Mt)/2,new vt(t,new p(Mt,i),0)}clone(){return new vt(this.pos,this.size,this.time)}update(t){Ji(),this.time+=t,this.dead=this.time>=Ut}handleCollision(t){}render(t,i){t.fillStyle=$,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),Ri,this.size.y*x)}}class jt extends l{color;time=0;state=0;constructor(t,i=0,r=0){super(t,H,k);this.color=Q,this.gravity.y=0,this.state=i,this.time=r}clone(){return new jt(v(this.pos),this.state,this.time)}update(t){if(O(this.pos,this.game.protaganist().pos)>150)this.state=0;switch(this.time+=t,this.state){case 0:{if(this.time>=Ut)this.time=0,this.state=1,this.color=Q;break}case 1:{if(this.time>=ji){this.time=0,this.state=0,this.color=$;let i=this.game.raycastUp(this.pos),r=i===null?c:this.pos.y-i.pos.y-1;this.game.dynamicEntities.push(vt.defaultConstructor(new p(this.pos.x,this.pos.y-r),r))}break}default:{console.error(`Should not be able to enter state ${this.state}`),this.state=0;break}}}handleCollision(t){}render(t,i){t.strokeStyle=this.color;let r=i.columnToScreen(this.pos.x),n=i.rowToScreen(this.pos.y),o=n+tt;t.beginPath(),t.moveTo(r,o),t.lineTo(r+C/2,n),t.lineTo(r+C,o),t.lineTo(r,o),t.stroke(),t.strokeStyle=K,t.beginPath(),t.moveTo(r,n),t.lineTo(r+C,n),t.stroke()}}var Hi=6,Mi=8,lr=0.4;class Nt extends l{movingRight;movingLeft;moveMod;jumpTime;squash;stretch;coinsCollected;maxColumn;agent;constructor(t,i,r=!1,n=!1,o=0,s=0,f=1,u=1,e=0,b=0){super(t,Zi,_);this.agent=i,this.movingRight=r,this.movingLeft=n,this.moveMod=o,this.jumpTime=s,this.squash=f,this.stretch=u,this.coinsCollected=e,this.maxColumn=b}clone(){return new Nt(v(this.pos),this.agent,this.movingRight,this.movingLeft,this.moveMod,this.jumpTime,this.squash,this.stretch,this.coinsCollected,this.maxColumn)}update(t){if(this.pos.y>Vi){this.dead=!0;return}if(this.velocity.x=0,this.agent.update(t),this.agent.movingRight)this.movingRight=!0,this.velocity.x=Hi,this.moveMod=Math.min(Mi,this.moveMod+t);if(this.agent.movingLeft)if(this.movingRight)this.movingRight=!1,this.velocity.x=0;else this.movingLeft=!0,this.velocity.x=-Hi,this.moveMod=Math.min(Mi,this.moveMod+t);if(this.jumpTime<lr&&this.agent.jumping){if(this.jumpTime===0)this.velocity.y=-15;else if(this.jumpTime<0.2)this.velocity.y-=2;this.velocity.y=Math.max(-20,this.velocity.y),this.squash=Math.min(1.03,this.squash+0.01),this.stretch=Math.max(0.97,this.stretch-0.01),this.jumpTime+=t}else if(this.squash!=this.stretch)this.squash+=0.01,this.stretch-=0.01;this.maxColumn=Math.max(this.pos.x,this.maxColumn)}handleCollision(t){switch(t.type){case k:{let i=t,r=a(z(this.pos,F(this.size,0.5)),z(i.pos,F(i.size,0.5))),n=z(this.size,i.size);F(n,0.5);let o=Math.abs(Math.atan(r.y/r.x));if(!(o<0.96&&o>0.698)&&Math.abs(r.x/this.size.x)>Math.abs(r.y/this.size.y))if(r.x<0)this.pos.x=i.pos.x-this.size.x;else this.pos.x=i.pos.x+i.size.x;else if(r.y>0)this.pos.y=i.pos.y+i.size.y;else this.pos.y=i.pos.y-this.size.y,this.velocity.y=0,this.jumpTime=0,this.stretch=1.01,this.squash=0.99;break}case Ct:{++this.coinsCollected;break}case Y:case B:{this.dead=!0;break}case Bt:{this.jumpTime=0,this.velocity.y=Math.min(this.velocity.y,0);break}default:{console.warn(`Player unhandled collision type: ${t.type}.`);break}}}render(t,i){t.fillStyle=ki;let r=i.columnToScreen(this.pos.x),n=i.rowToScreen(this.pos.y),o=Kt*this.squash,s=It*this.stretch;if(this.movingRight){let f=new Path2D;f.moveTo(r,n),f.lineTo(r-this.moveMod,n+o),f.lineTo(r+s-this.moveMod,n+o),f.lineTo(r+s,n),f.closePath(),t.fill(f,"evenodd"),this.movingRight=!1}else if(this.movingLeft){let f=new Path2D;f.moveTo(r,n),f.lineTo(r+this.moveMod,n+o),f.lineTo(r+s+this.moveMod,n+o),f.lineTo(r+s,n),f.closePath(),t.fill(f,"evenodd"),this.movingLeft=!1}else t.fillRect(r,n,s,o)}}class xt extends l{constructor(t,i){super(t,Bi,B);this.velocity.y=i,this.gravity.y=0}static defaultConstructor(t){return t.x+=0.25,t.y+=0.1,new xt(t,3)}clone(){return new xt(v(this.pos),this.velocity.y)}update(t){this.velocity.y*=$t(this.pos.y>0&&this.pos.y<=c)}handleCollision(t){if(t.type===k){let i=a(z(this.pos,F(this.size,0.5)),z(t.pos,F(t.size,0.5))),r=z(this.size,t.size);if(F(r,0.5),Math.abs(i.x/this.size.x)<Math.abs(i.y/this.size.y))if(this.velocity.y*=-1,i.y>0)this.pos.y=t.pos.y+t.size.y;else this.pos.y=t.pos.y-this.size.y}else if(t.type===Y)this.dead=!0}render(t,i){t.fillStyle=$,t.fillRect(i.columnToScreen(this.pos.x),i.rowToScreen(this.pos.y),rt,it)}}class Li{moveRight;moveLeft;jump;constructor(t,i,r){this.moveRight=t,this.moveLeft=i,this.jump=r}}var Wt=[new Li(!0,!1,!1)],Ti=Wt.length;class hi{queue=[];insert(t,i){if(this.queue.length==0){this.queue.push([t,i]);return}let r=0,n=this.queue.length,o;while(r<n)if(o=Math.floor((r+n)/2),t>=this.queue[o][0])n=o;else r=o+1;this.queue.splice(r,0,[t,i])}pop(){return this.queue.pop()[1]}length(){return this.queue.length}}var vr=0.032;class mi{depth;model;action;pastNode;constructor(t,i,r,n=void 0){this.depth=t,this.model=i,this.action=r,this.pastNode=n}}function xr(t,i){let r=new Set;r.add(t.hash());let n=new hi;n.insert(0,new mi(0,t,Wt[0]));let o=void 0,s=0;while(n.length()>0){let e=n.pop();console.log(`depth: ${e.depth}, #actions: ${n.length()}`);let b=e.depth+1;if(b>20)continue;for(s=0;s<Ti;++s){let V=Wt[s],g=e.model.clone();if(g.protaganist().agent.set(V),g.update(vr),console.log(g.coins[i].dead),g.coins[i].dead){o=e,n.length=0;break}if(g.protaganist().dead)continue;let A=g.hash();if(r.has(A)){console.log("clash!",A);continue}r.add(A);let _i=new mi(b,g,V,e);n.insert(b+wi(g.protaganist().pos,g.coins[i].pos),_i)}}if(o===void 0)return console.error("A* Error: Could not find target."),[void 0,[]];let f=o.model,u=[];while(o.depth>0)u.push(o.action),o=o.pastNode;return[f,u]}function Di(t){let i=t.clone(),r=[],n=0,o=t.coins.length;for(;n<o;++n){if(i.coins[n].dead)continue;let[s,f]=xr(i,n);if(s===void 0)return console.error(`Pathing failed for coin at (${S(i.coins[n].pos)})`),[];i=s;let u=f.length;for(let e=0;e<u;++e)r.push(f[e])}return r}class E{staticEntities=[];dynamicEntities=[];coins=[];numColumns;constructor(t,i){if(t===null)return;let r=t.length;if(r!==c){console.error("Level should have 15 rows!");return}this.dynamicEntities.push(new Nt(new p(2,12),Ki(i,this)));let n=t[0].length;this.numColumns=n;for(let s=0;s<r;++s){let f=t[s];if(n!==f.length){console.error(`Every row in the level should have the same number of columns! (${n} !== ${f.length}).`);return}for(let u=0;u<n;++u){let e=f[u];if(e==="X")this.staticEntities.push(new Rt(new p(u,s)));else if(e==="^")this.dynamicEntities.push(new jt(new p(u,s)));else if(e==="T")this.dynamicEntities.push(new Yt(new p(u,s)));else if(e==="o"){let b=yt.defaultConstructor(new p(u,s));this.dynamicEntities.push(b),this.coins.push(b)}else if(e=="b")this.dynamicEntities.push(bt.defaultConstructor(new p(u,s)));else if(e==="H")this.dynamicEntities.push(lt.defaultConstructor(new p(u,s),n));else if(e==="V")this.dynamicEntities.push(xt.defaultConstructor(new p(u,s)));else if(e==="C")this.dynamicEntities.push(pt.defaultConstructor(new p(u,s)));else if(e!=="-")console.error(`Unhandled tile type: ${f[u]}`)}}let o=0;for(;o<this.staticEntities.length;++o)this.staticEntities[o].game=this;for(let s=0;s<this.dynamicEntities.length;++s)this.dynamicEntities[s].game=this;if(i===ri){let s=Di(this);this.protaganist().agent=new ft(s)}}clone(){let t=new E(null,0),i=this.dynamicEntities.length,r=0;for(;r<i;++r){let n=this.dynamicEntities[r].clone();n.game=t,t.dynamicEntities.push(n)}return t.staticEntities=this.staticEntities,t.coins=this.coins,t}hash(){let t="",i=this.dynamicEntities.length;for(let r=0;r<i;++r)t+=S(this.dynamicEntities[r].pos);return t}update(t,i=1){t=t/i;for(let r=0;r<i;++r){let n=this.dynamicEntities.length,o=this.staticEntities.length,s,f=0;for(;f<n;++f){let u=this.dynamicEntities[f];if(u.update(t),u.dead){if(f==0)break;this.dynamicEntities.splice(f,1),--f,--n}u.physicsUpdate(t);for(s=f+1;s<n;++s)u.collision(this.dynamicEntities[s]);for(s=0;s<o;++s)u.collision(this.staticEntities[s])}}}render(t,i){i.update(this.dynamicEntities[0].pos.x);let r=this.staticEntities.length,n=0;for(;n<r;++n)this.staticEntities[n].render(t,i);r=this.dynamicEntities.length;for(n=0;n<r;++n)this.dynamicEntities[n].render(t,i)}state(){let t=this.dynamicEntities[0];if(t.coinsCollected>=this.coins.length)return Qt;if(t.dead)return zt;return G}protaganist(){return this.dynamicEntities[0]}fitness(){return 1-this.dynamicEntities[0].coinsCollected/this.coins.length}raycastUp(t){let i=v(t);i.y-=1;let r=this.staticEntities.length,n;while(i.y>=0){for(n=0;n<r;++n){let o=this.staticEntities[n];if(yi(i,o.pos))return o}i.y-=1}return null}}class pi extends P{ctx;transitionScene;camera;game;constructor(t,i){super();this.ctx=t,this.transitionScene=i,this.camera=new et}onEnter(){let t=Fi(D);console.log(D[t]),this.game=new E(D[t],ii)}update(t){if(this.game.state()!==G)this.onEnter();if(y.isKeyDown(14))this.transitionScene.targetScene=j,this.changeScene=Z;this.game.update(t)}render(){this.ctx.clearRect(0,0,J,U),this.game.render(this.ctx,this.camera),this.ctx.fillStyle="black",this.ctx.fillRect(240,60,240,47),this.ctx.fillRect(210,234,295,39),this.ctx.fillStyle=Q,this.ctx.font="48px Arial",this.ctx.fillText("Recformer",247,100),this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to start",220,U*0.55)}_onExit(){}}class di{playerIsOnLastLevel=!1;keys;columnsPerLevel;lossesInARow=0;playerWonLastRound=!1;constructor(){}update(t,i){let r=this.keys.length,n=[];if(t){for(let s=0;s<r;++s)n.push(1);this.lossesInARow=0}else{let s=i;for(let f=0;f<r;++f)if(s>this.columnsPerLevel[f])n[f]=1,s-=this.columnsPerLevel[f];else{n[f]=s/this.columnsPerLevel[f];break}}let o=n.length;for(let s=0;s<o;++s){let f=n[s],u=this.keys[s],e=h.getNode(u);if(f===1){if(!h.hasEdge(X,u))h.addDefaultEdge(X,u,[[u,1],[d,0]])}++e.visitedCount,e.sumPercentCompleted+=f,e.updateReward();let b=e.sumPercentCompleted/e.visitedCount,V=1-b;h.mapEdges((g)=>{if(g.tgt===u)g.probability[0][1]=b,g.probability[1][1]=V})}if(!t){++this.lossesInARow;for(let s=0;s<this.lossesInARow;++s){let f=h.getNode(X).neighbors,u=f.length;if(u===1)break;let e="",b=-1e4;for(let V=0;V<u;++V){let g=f[V],A=h.getNode(g).depth;if(A>b)e=g,b=A}console.log("removing edge:",e,b),h.removeEdge(X,e)}}this.playerWonLastRound=t}get(t){let i=ei(h,0.95,!0,!0,20);if(this.columnsPerLevel=[],this.playerWonLastRound)this.keys=[N(i[X])];else this.keys=[X];for(let o=0;o<t;++o){let s=N(i[this.keys[o]]);if(this.keys.push(s),s===nt)break}this.keys.splice(0,1),this.playerIsOnLastLevel=this.keys.includes(nt);let r=Array(c).fill(""),n=this.keys.length;for(let o=0;o<n;++o){let s=D[this.keys[o]];this.columnsPerLevel.push(s[0].length);for(let f=0;f<c;++f)r[f]+=s[f]}return r}}class bi extends P{ctx;transitionScene;agentType;game;camera;levelDirector;constructor(t,i,r){super();this.ctx=t,this.agentType=r,this.transitionScene=i,this.camera=new et,this.levelDirector=new di}onEnter(){let t=this.levelDirector.get(Xi);this.game=new E(t,this.agentType)}update(t){this.game.update(t);let i=this.game.state();switch(i){case G:break;case zt:{this.transitionScene.targetScene=Xt,this.changeScene=Z;break}case Qt:{if(this.levelDirector.playerIsOnLastLevel)this.transitionScene.targetScene=Vt;else this.transitionScene.targetScene=st;this.changeScene=Z;break}default:{console.error(`Unhandled game state type: ${i}`);break}}}render(){this.ctx.clearRect(0,0,J,U),this.game.render(this.ctx,this.camera)}_onExit(){let t=this.game.fitness();console.log(`Fitness: ${t}`),this.levelDirector.update(this.transitionScene.targetScene===st,t)}}window.addEventListener("load",()=>{zi(()=>{y.init();let t=document.createElement("canvas");t.setAttribute("id","canvas"),t.width=J,t.height=U;let i=t.getContext("2d");document.getElementById("game").appendChild(t);let r=new St,n=new Et(i);r.registerScene(Z,n),r.registerScene(ot,new pi(i,n)),r.registerScene(j,new bi(i,n,ni)),r.registerScene(Vt,new Lt(i)),r.registerScene(st,new Tt(i,n)),r.registerScene(Xt,new Dt(i,n));let o=r.getScene(ot);o.onEnter();let s=0,f=(u)=>{let e=Math.min(0.05,(u-s)/1000);s=u,o.update(gt(e,0.01,0.2)),o.render();let b=o.changeScene;if(b!==void 0)o.onExit(),o=r.getScene(b),o.onEnter();window.requestAnimationFrame(f)};window.requestAnimationFrame(f)})});
