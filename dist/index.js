class ot{scenes={};registerScene(t,s){if(this.scenes[t]===void 0)this.scenes[t]=s;else console.error(`Key "${t}" for scene already exists! Scene not added to SceneManager.`)}getScene(t){return this.scenes[t]}}class m{changeScene;onExit(){this.changeScene=void 0,this._onExit()}}var O="main menu",R="game",L="player won",S="transition",B="lost",M="won";var g=720,I=480,v=32,N=15,Zt=17,Y=20,X=30,Ut=0.625,qt=0.9375,a=31,k=31,F=0.96875,U=0.96875,Q=16,W=16,V=0.5,J=0.5,G=25,D=15,K=0.78125,tt=0.46875,Qt=3,ut=0.12109375,Wt=3.875,st=0.6,Vt=2,Jt=2.5,Tt=120,Ht=10,$="start",A="end",h="death";var T;((d)=>{d[d.LEFT=0]="LEFT";d[d.RIGHT=1]="RIGHT";d[d.DOWN=2]="DOWN";d[d.UP=3]="UP";d[d.A=4]="A";d[d.D=5]="D";d[d.E=6]="E";d[d.G=7]="G";d[d.H=8]="H";d[d.I=9]="I";d[d.Q=10]="Q";d[d.R=11]="R";d[d.S=12]="S";d[d.W=13]="W";d[d.SPACE=14]="SPACE";d[d.ESCAPE=15]="ESCAPE";d[d.ENTER=16]="ENTER";d[d.SHIFT=17]="SHIFT";d[d.INVALID=18]="INVALID"})(T||={});class c{static _keys=[];static init(){for(let t=0;t<Object.keys(T).length;++t)c._keys.push(!1);window.addEventListener("keydown",c.onKeyDown),window.addEventListener("keyup",c.onKeyUp)}static isKeyDown(...t){let s=t.length;for(let n=0;n<s;++n)if(c._keys[t[n]])return!0;return!1}static keyStrToKey(t){switch(t){case"Down":case"ArrowDown":return 2;case"Up":case"ArrowUp":return 3;case"Right":case"ArrowRight":return 1;case"Left":case"ArrowLeft":return 0;case" ":case"Space":return 14;case"Escape":return 15;case"a":case"A":return 4;case"e":case"E":return 6;case"s":case"S":return 12;case"d":case"D":return 5;case"w":case"W":return 13;case"r":case"R":return 11;case"q":case"Q":return 10;case"g":case"G":return 7;case"h":case"H":return 8;case"i":case"I":return 9;case"Shift":return 17;case"Enter":return 16;default:return console.warn(`Unhandled key: ${t}.`),18}}static onKeyDown(t){let s=c.keyStrToKey(t.key);if(c._keys[s]=!0,s==2||s==3||s==0||s==1)t.preventDefault();return!1}static onKeyUp(t){return c._keys[c.keyStrToKey(t.key)]=!1,!1}static clear(){for(let t=0;t<c._keys.length;++t)c._keys[t]=!1}}class y{x;y;constructor(t,s){this.x=t,this.y=s}copy(){return new y(this.x,this.y)}zero(){this.x=0,this.y=0}equals(t){return this.x==t.x&&this.y==t.y}add(t){return new y(this.x+t.x,this.y+t.y)}addInPlace(t){this.x+=t.x,this.y+=t.y}subtract(t){return new y(this.x-t.x,this.y-t.y)}subtractInPlace(t){this.x-=t.x,this.y-=t.y}scalarAdd(t){this.x+=t,this.y+=t}scalarSubtract(t){this.x-=t,this.y-=t}scalarMultiply(t){return new y(this.x*t,this.y*t)}scalarMultiplyInPlace(t){this.x*=t,this.y*=t}dot(t){return this.x*t.x+this.y*t.y}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){let t=this.magnitude();this.x/=t,this.y/=t}squareDistance(t){return Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2)}}var q="rgba(150,150,255,1)";var Lt=Math.floor(g/v)-1;class ft extends m{ctx;transitionScene;fakePlayerPos;sign;constructor(t,s){super();this.ctx=t,this.transitionScene=s,this.fakePlayerPos=new y(10,(N-2)*v),this.sign=1}onEnter(){this.ctx.clearRect(0,0,g,I),this.ctx.fillStyle=q,this.ctx.font="48px Arial",this.ctx.fillText("Recformer",247,100),this.ctx.fillStyle="white",this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to start",220,I*0.55);let t=this.fakePlayerPos.y+v;this.ctx.strokeStyle="white";for(let s=0;s<25;++s)this.ctx.strokeRect(s*v,t,a,k);this.ctx.fillStyle=q}update(t){if(c.isKeyDown(14))this.transitionScene.targetScene=R,this.changeScene=S;let s=this.fakePlayerPos.x;if(s<1||s>Lt)this.sign*=-1;this.fakePlayerPos.x+=t*this.sign}render(){let t=this.fakePlayerPos.x*v,s=(N-2)*v;this.ctx.clearRect(0,this.fakePlayerPos.y,g,X),this.ctx.fillRect(t,s,Y,X)}_onExit(){}}class dt{startCol=0;endCol=0;offsetX=0;colsPerScreen=Math.ceil(g/v);update(t){let s=t-this.colsPerScreen/2;this.startCol=Math.max(0,Math.floor(s)),this.endCol=this.startCol+this.colsPerScreen,this.offsetX=-s*v+this.startCol*v}columnToScreen(t){return(t-this.startCol)*v+this.offsetX}rowToScreen(t){return t*v}}function _t(t,s,n,r){let{x:i,y:o}=t,e=i+s.x,f=o+s.y,l=n.x,b=n.y,w=l+r.x,z=b+r.y;return i<w&&e>l&&o<z&&f>b}class p{pos;size;type;dead=!1;velocity=new y(0,0);gravity=new y(0,100);constructor(t,s,n,r,i){this.pos=new y(t,s),this.size=new y(n,r),this.type=i}collision(t){if(_t(this.pos,this.size,t.pos,t.size))this.handleCollision(t),t.handleCollision(this)}physicsUpdate(t){this.velocity.addInPlace(this.gravity.scalarMultiply(t)),this.velocity.y=Math.min(this.velocity.y,30),this.pos.addInPlace(this.velocity.scalarMultiply(t))}}var H=0,E=1,rt=2,C=3,nt=4;var Ot=6,Xt=8,Bt=0.4;class lt extends p{movingRight=!1;movingLeft=!1;moveMod=0;jumpTime=0;squash=1;stretch=1;coinsCollected=0;maxColumn=0;constructor(t,s){super(t,s,Ut,qt,H)}update(t){if(this.pos.y>Zt){this.dead=!0;return}if(this.velocity.x=0,c.isKeyDown(5,1))this.movingRight=!0,this.velocity.x=Ot,this.moveMod=Math.min(Xt,this.moveMod+t);if(c.isKeyDown(4,0))if(this.movingRight)this.movingRight=!1,this.velocity.x=0;else this.movingLeft=!0,this.velocity.x=-Ot,this.moveMod=Math.min(Xt,this.moveMod+t);if(this.jumpTime<Bt&&c.isKeyDown(14,3)){if(this.jumpTime===0)this.velocity.y=-15;else if(this.jumpTime<0.2)this.velocity.y-=2;this.squash=Math.min(1.03,this.squash+0.01),this.stretch=Math.max(0.97,this.stretch-0.01),this.jumpTime+=t}else if(this.squash!=this.stretch)this.squash+=0.01,this.stretch-=0.01;this.maxColumn=Math.max(this.pos.x,this.maxColumn)}handleCollision(t){switch(t.type){case E:{let s=this.pos.add(this.size.scalarMultiply(0.5)),n=t.pos.add(t.size.scalarMultiply(0.5)),r=s.subtract(n);this.size.add(t.size).scalarMultiply(0.5);let o=Math.abs(Math.atan(r.y/r.x));if(!(o<0.96&&o>0.698)&&Math.abs(r.x/this.size.x)>Math.abs(r.y/this.size.y))if(r.x<0)this.pos.x=t.pos.x-this.size.x;else this.pos.x=t.pos.x+t.size.x;else if(r.y>0)this.pos.y=t.pos.y+t.size.y;else this.pos.y=t.pos.y-this.size.y,this.velocity.y=0,this.jumpTime=0,this.stretch=1.01,this.squash=0.99;break}case rt:{++this.coinsCollected;break}case C:{this.dead=!0,console.log("Ran into an enemy! :/");break}case nt:{this.jumpTime=0;break}default:{console.warn(`Player unhandled collision type: ${t.type}.`);break}}}render(t,s){t.fillStyle=q;let n=s.columnToScreen(this.pos.x),r=s.rowToScreen(this.pos.y),i=X*this.squash,o=Y*this.stretch;if(this.movingRight){let e=new Path2D;e.moveTo(n,r),e.lineTo(n-this.moveMod,r+i),e.lineTo(n+o-this.moveMod,r+i),e.lineTo(n+o,r),e.closePath(),t.fill(e,"evenodd"),this.movingRight=!1}else if(this.movingLeft){let e=new Path2D;e.moveTo(n,r),e.lineTo(n+this.moveMod,r+i),e.lineTo(n+o+this.moveMod,r+i),e.lineTo(n+o,r),e.closePath(),t.fill(e,"evenodd"),this.movingLeft=!1}else t.fillRect(n,r,o,i)}}class ht extends p{constructor(t,s){super(t,s,F,U,E)}update(t){}handleCollision(t){}render(t,s){t.strokeStyle="white",t.strokeRect(s.columnToScreen(this.pos.x),s.rowToScreen(this.pos.y),a,k)}}class ct extends p{minY;maxY;yMod;constructor(t,s){super(t+0.25,s+0.25,V,J,rt);this.gravity.y=0,this.yMod=Math.random()*0.5,this.maxY=s+0.3,this.minY=s+0.15,this.velocity.y=this.yMod}update(t){if(this.pos.y>=this.maxY)this.velocity.y=-this.yMod;else if(this.pos.y<=this.minY)this.velocity.y=this.yMod}handleCollision(t){if(t.type===H)this.dead=!0}render(t,s){t.fillStyle="yellow",t.fillRect(s.columnToScreen(this.pos.x),s.rowToScreen(this.pos.y),Q,W)}}class pt extends p{maxColumns;constructor(t,s,n){super(t+0.25,s+0.25,K,tt,C);this.velocity.x=3,this.gravity.y=0,this.maxColumns=n}update(t){if(this.pos.x<0||this.pos.x>this.maxColumns)this.velocity.x*=-1}handleCollision(t){if(t.type===E){let s=this.pos.add(this.size.scalarMultiply(0.5)),n=t.pos.add(t.size.scalarMultiply(0.5)),r=s.subtract(n);if(this.size.add(t.size).scalarMultiply(0.5),Math.abs(r.x/this.size.x)>Math.abs(r.y/this.size.y))if(this.velocity.x*=-1,r.x<0)this.pos.x=t.pos.x-this.size.x;else this.pos.x=t.pos.x+t.size.x}else if(t.type==C)this.dead=!0}render(t,s){t.fillStyle="red",t.fillRect(s.columnToScreen(this.pos.x),s.rowToScreen(this.pos.y),G,D)}}class bt extends p{constructor(t,s){super(t,s+0.1,tt,K,C);this.velocity.y=3,this.gravity.y=0,this.pos.x+=0.25}update(t){if(this.pos.y<0||this.pos.y>=N)this.velocity.y*=-1}handleCollision(t){if(t.type===E){let s=this.pos.add(this.size.scalarMultiply(0.5)),n=t.pos.add(t.size.scalarMultiply(0.5)),r=s.subtract(n);if(this.size.add(t.size).scalarMultiply(0.5),Math.abs(r.x/this.size.x)<Math.abs(r.y/this.size.y))if(this.velocity.y*=-1,r.y>0)this.pos.y=t.pos.y+t.size.y;else this.pos.y=t.pos.y-this.size.y}else if(t.type===C)this.dead=!0}render(t,s){t.fillStyle="red",t.fillRect(s.columnToScreen(this.pos.x),s.rowToScreen(this.pos.y),D,G)}}class xt{src;tgt;probability;constructor(t,s,n){this.src=t,this.tgt=s,this.probability=n}}class P{name;reward;utility;isTerminal;neighbors;constructor(t,s,n,r,i){this.name=t,this.reward=s,this.utility=n,this.isTerminal=r,this.neighbors=i}}class it{nodes;edges;constructor(){this.nodes={},this.edges={}}getNode(t){return this.nodes[t]}hasNode(t){return t in this.nodes}addNode(t){this.nodes[t.name]=t}addDefaultNode(t,s=1,n=0,r=!1,i=null){if(i==null)i=[];this.nodes[t]=new P(t,s,n,r,i)}removeNode(t){let s=[];for(let n of Object.values(this.edges)){if(n.src==t||n.tgt==t)s.push(n);let r=n.probability,i=-1;for(let l=0;l<r.length;l++){let[b,w]=r[l];if(b==t){i=l;break}}if(i==-1)continue;let o=r[i][1];r.splice(i,1);let e=r.length,f=o/e;n.probability=r.map(([l,b])=>[l,b+f])}for(let n of s)this.removeEdge(n.src,n.tgt);delete this.nodes[t]}getEdge(t,s){return this.edges[`${t},${s}`]}hasEdge(t,s){return`${t},${s}`in this.edges}addEdge(t){this.edges[`${t.src},${t.tgt}`]=t;let s=this.nodes[t.src].neighbors;if(!s.includes(t.tgt))s.push(t.tgt)}addDefaultEdge(t,s,n=null){if(n==null)n=[[s,1]];this.addEdge(new xt(t,s,n))}removeEdge(t,s){let n=this.nodes[t],r=n.neighbors.indexOf(s);n.neighbors.splice(r,1),delete this.edges[`${t},${s}`]}neighbors(t){return this.nodes[t].neighbors}setNodeUtilities(t){for(let[s,n]of Object.entries(t))this.nodes[s].utility=n}utility(t){return this.nodes[t].utility}reward(t){return this.nodes[t].reward}isTerminal(t){return this.nodes[t].isTerminal}mapNodes(t){for(let s of Object.values(this.nodes))t(s)}mapEdges(t){for(let s of Object.values(this.edges))t(s)}}function Z(t){return t[Math.floor(Math.random()*t.length)]}function _(t,s,n,r){let i=t.getEdge(s,n).probability,o=i.length,e=0;for(let f=0;f<o;++f){let[l,b]=i[f];e+=b*(t.reward(l)+r*t.utility(l))}return e}function et(t,s,n){let r=t.getNode(s);if(r.isTerminal)return 0;let i=r.neighbors,o=i.length,e=-1/0;for(let f=0;f<o;++f)e=Math.max(e,_(t,s,i[f],n));return e}function vt(t){for(let s in t.nodes)t.nodes[s].utility=0}function at(t){let s={};for(let n in t.nodes)if(!t.getNode(n).isTerminal)s[n]=[...t.neighbors(n)];return s}function gt(t,s){let n={};for(let r in t.nodes){if(t.getNode(r).isTerminal)continue;let i=-1/0,o=[];for(let e of t.neighbors(r)){let f=_(t,r,e,s);if(f===i)o.push(e);else if(f>i)i=f,o.length=0,o.push(e)}n[r]=o}return n}function Mt(t,s,n,r){for(let i=0;i<r;++i)for(let o in t.nodes){let e=t.getNode(o);if(!e.isTerminal)e.utility=_(t,o,Z(s[o]),n)}}function Yt(t,s,n,r){for(let i=0;i<r;++i){let o={};for(let e in t.nodes)if(!t.getNode(e).isTerminal)o[e]=_(t,e,Z(s[e]),n);t.setNodeUtilities(o)}}function Gt(t,s,n,r){for(let i=0;i<r;++i)for(let o in t.nodes)t.getNode(o).utility=et(t,o,n)}function Dt(t,s,n,r){for(let i=0;i<r;++i){let o={};for(let e in t.nodes)o[e]=et(t,e,n);t.setNodeUtilities(o)}}function At(t,s,n){let r=!1;for(let i in t.nodes){if(t.getNode(i).isTerminal)continue;let o=null,e=-1/0;for(let f of t.neighbors(i)){let l=_(t,i,f,n);if(l===e);else if(l>e)o=f,e=l}if(Z(s[i])!==o)s[i].length=0,s[i].push(o),r=!0}return r}function yt(t,s,n=!1,r=!1,i=10,o=!0){if(o)vt(t);let e=at(t),f;if(n&&r)f=Mt;else if(n&&!r)f=Yt;else if(!n&&r)f=Gt;else f=Dt;let l=!0;while(l)f(t,e,s,i),l=At(t,e,s);return f(t,e,s,i),At(t,e,s),gt(t,s)}class x extends P{visitedCount;sumPercentCompleted;depth;designerReward;playerReward;constructor(t,s,n,r,i,o){super(t,s,n,r,i);this.designerReward=s,this.playerReward=0,this.depth=o,this.visitedCount=1,this.sumPercentCompleted=1}updateReward(){this.reward=this.designerReward*this.visitedCount}}var u=new it;u.addNode(new x($,0,0,!1,[],-1));u.addNode(new x(h,-1,0,!0,[],-1));u.addNode(new x(A,1,0,!0,[],-1));u.addNode(new x("1-a",-0.95,0,!1,[],1));u.addNode(new x("2-a",-0.925,0,!1,[],2));u.addNode(new x("2-b",-0.925,0,!1,[],2));u.addNode(new x("3-a",-0.9,0,!1,[],3));u.addNode(new x("3-b",-0.9,0,!1,[],3));u.addNode(new x("4-a",-0.825,0,!1,[],4));u.addNode(new x("4-b",-0.825,0,!1,[],4));u.addNode(new x("5-a",-0.8,0,!1,[],5));u.addNode(new x("5-b",-0.8,0,!1,[],5));u.addNode(new x("5-c",-0.8,0,!1,[],5));u.addNode(new x("6-a",-0.775,0,!1,[],6));u.addNode(new x("7-a",-0.75,0,!1,[],7));u.addNode(new x("6-b",-0.775,0,!1,[],6));u.addNode(new x("1-b",-0.95,0,!1,[],1));u.addDefaultEdge($,"1-a",[["1-a",0.99],[h,0.01]]);u.addDefaultEdge("1-a","2-b",[["2-b",0.99],[h,0.01]]);u.addDefaultEdge("1-a","2-a",[["2-a",0.99],[h,0.01]]);u.addDefaultEdge("2-a","3-a",[["3-a",0.99],[h,0.01]]);u.addDefaultEdge("2-b","3-b",[["3-b",0.99],[h,0.01]]);u.addDefaultEdge("3-a","4-b",[["4-b",0.99],[h,0.01]]);u.addDefaultEdge("3-a","4-a",[["4-a",0.99],[h,0.01]]);u.addDefaultEdge("3-b","4-b",[["4-b",0.99],[h,0.01]]);u.addDefaultEdge("3-b","4-a",[["4-a",0.99],[h,0.01]]);u.addDefaultEdge("4-a","5-b",[["5-b",0.99],[h,0.01]]);u.addDefaultEdge("4-a","5-a",[["5-a",0.99],[h,0.01]]);u.addDefaultEdge("4-a","5-c",[["5-c",0.99],[h,0.01]]);u.addDefaultEdge("4-b","5-b",[["5-b",0.99],[h,0.01]]);u.addDefaultEdge("4-b","5-a",[["5-a",0.99],[h,0.01]]);u.addDefaultEdge("4-b","5-c",[["5-c",0.99],[h,0.01]]);u.addDefaultEdge("5-a","6-a",[["6-a",0.99],[h,0.01]]);u.addDefaultEdge("5-a","6-b",[["6-b",0.99],[h,0.01]]);u.addDefaultEdge("5-b","6-a",[["6-a",0.99],[h,0.01]]);u.addDefaultEdge("5-b","6-b",[["6-b",0.99],[h,0.01]]);u.addDefaultEdge("5-c","6-a",[["6-a",0.99],[h,0.01]]);u.addDefaultEdge("5-c","6-b",[["6-b",0.99],[h,0.01]]);u.addDefaultEdge("6-a","7-a",[["7-a",0.99],[h,0.01]]);u.addDefaultEdge("7-a","end",[["end",0.99],[h,0.01]]);u.addDefaultEdge("6-b","7-a",[["7-a",0.99],[h,0.01]]);u.addDefaultEdge($,"1-b",[["1-b",0.99],[h,0.01]]);u.addDefaultEdge("1-b","2-b",[["2-b",0.99],[h,0.01]]);u.addDefaultEdge("1-b","2-a",[["2-a",0.99],[h,0.01]]);var Pt={"1-a":["------------XXX-","-------------T--","----------------","----------------","----------------","----------------","----------------","----------------","----------------","----------------","-----------o----","--------o-XX--b-","------o-XXXX----","------XXXXXX----","XXXXXXXXXXXXXXXX"],"2-a":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","-------XXXXXXXX-------","----------------------","-------V--o---V-----o-","----------------------","XXXXXXXXXXXXXXXXXXXXXX"],"2-b":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","-----------o----------","--------------------o-","-----X---H-----X------","XXXXXXXXXXXXXXXXXXXXXX"],"3-a":["----------------------","----------------------","----------------------","----------------------","-----------o----------","----------------------","---------XXXXX--------","-----------o----------","----------------------","-------X-H-----X------","---XX--XXXXXXXXX--XX--","----------------------","-------V---o---V----o-","----------------------","XXXXXXXXXXXXXXXXXXXXXX"],"3-b":["----------------------","----------------------","----------------------","----------------------","----------o-----------","----------------------","--------XXXXX---------","--------V---V---------","----------o-----------","----------------------","------XXXXXXXXX-------","----------------------","----------o---------o-","-----X---H-----X------","XXXXXXXXXXXXXXXXXXXXXX"],"4-a":["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------XXX---","-----------------V----","-------X---XX-----V---","------XX------o-V---o-","-----XXX--------------","XXXXXXXX---XXXXXXXXXXX"],"4-b":["--------------------XX","--------------------XX","--------------------XX","--------------------XX","--------------------XX","-----------X-H---o--XX","-----------------o--XX","---------o----------XX","-----------XXXXXXX--XX","--------------------XX","-------X------------XX","------XXX-----------XX","-----XXXXX-----------o","----XXXXXXX-----------","XXXXXXXXXXXXXXXX--XXXX"],"5-a":["--------XXXXXXXXXXXXXX--------","-------------------ooX--------","---------------------X--------","---------------------X--------","------------------XXXX--------","------------------X-----------","-----------o--XXXXX-----------","------------------------------","---------XX-----------------o-","------------------------------","--------------XX---XXX----XXXX","------------------------------","----------XX------------------","------------------------------","XXXXXXXX----------------------"],"5-b":["------------------------------","-o----------------------------","------------------------------","XXX---------------------------","------------------------------","-----XXX----------------------","------------------------------","-----------XXX----------------","-o--------------------------o-","------XXX---------------------","XXX-----------------------XXXX","------------XXX-------XX------","------------------XX----------","------------------------------","XXXXXXXX---XXXXX--------------"],"5-c":["o-----------------------------","------------------------------","X---XX------------------------","------------------------------","------------------------------","XX----------------------------","--------XXXXX-----------------","--------Xoo-------------------","XXX-----Xoo----o------------o-","--------X---------------------","--------XXX---XX----XX----XXXX","XXXX--------------------------","------------------------------","------------------------------","XXXXXXXX----------------------"],"6-a":["----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","-------oo---XXXXXXXX----------","-o----------XXXXXXXX----------","------XXXX--XXXXXXXX----------","--------------o---------------","XXXX--------------------------","-------------XXXX-----------o-","---------------------XX-------","XXXXXXXX-----------------XXXXX"],"7-a":["-------------------V---------------","-----------------o---o-------------","------------X-H------------H--XXX--","-----V------XXXXXXXXXXXXXXXXXXXXX--","--------XX----o--------------------","-----------------------------------","-----------XXXXXX---Ho-------------","-----------------------------------","-------------V------XX--------H----","-----------------------------------","XX--------o------XXXXX----H--------","-----------------------------------","---X----H----H-X-----------------o-","---XXXXXXXXXXXXX-------------------","XXXX--------------------------XXXXX"],end:["----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----------------------","----oooooooooooooooooo","XXXXXXXXXXXXXXXXXXXXXX"],"6-b":["----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX----------","----------XXXXXXXXXX--o-------","-o--------XXXXXXXXXX----------","----------XXXXXXXXXX--X-------","----------XXXXXXXXXX----------","XXX-------XXXXXXXXXXX---------","------XX-----oooo-----------o-","------------------------------","XXXX--------XXXXXX---XX---XXXX"],"1-b":["---------XXX----","----------T-----","----------------","----------------","----------------","----------------","----------------","----------------","-------oo-------","----------------","-------XX-------","----o-XXXX-o----","-----XXXXXX-----","---XXXXXXXXXX---","XXXXXXXXXXXXXXXX"]};class mt{playerIsOnLastLevel=!1;keys;columnsPerLevel;lossesInARow=0;playerWonLastRound=!1;constructor(){}update(t,s){let n=this.keys.length,r=[];if(t){for(let o=0;o<n;++o)r.push(1);this.lossesInARow=0}else{let o=s;for(let e=0;e<n;++e)if(o>this.columnsPerLevel[e])r[e]=1,o-=this.columnsPerLevel[e];else{r[e]=o/this.columnsPerLevel[e];break}}let i=r.length;for(let o=0;o<i;++o){let e=r[o],f=this.keys[o],l=u.getNode(f);if(e===1){if(!u.hasEdge($,f))u.addDefaultEdge($,f,[[f,1],[h,0]])}++l.visitedCount,l.sumPercentCompleted+=e,l.updateReward();let b=l.sumPercentCompleted/l.visitedCount,w=1-b;u.mapEdges((z)=>{if(z.tgt===f)z.probability[0][1]=b,z.probability[1][1]=w})}if(!t){++this.lossesInARow;for(let o=0;o<this.lossesInARow;++o){let e=u.getNode($).neighbors,f=e.length;if(f===1)break;let l="",b=-1e4;for(let w=0;w<f;++w){let z=e[w],j=u.getNode(z).depth;if(j>b)l=z,b=j}console.log("removing edge:",l,b),u.removeEdge($,l)}}this.playerWonLastRound=t}get(t){let s=yt(u,0.95,!0,!0,20);if(this.columnsPerLevel=[],this.playerWonLastRound)this.keys=[Z(s[$])];else this.keys=[$];for(let i=0;i<t;++i){let o=Z(s[this.keys[i]]);if(this.keys.push(o),o===A)break}this.keys.splice(0,1),this.playerIsOnLastLevel=this.keys.includes(A);let n=Array(N).fill(""),r=this.keys.length;for(let i=0;i<r;++i){let o=Pt[this.keys[i]];this.columnsPerLevel.push(o[0].length);for(let e=0;e<N;++e)n[e]+=o[e]}return n}}class St extends p{spawnLaser;vertical;color;time=0;state=0;constructor(t,s,n,r){super(t,s,F,U,E);this.spawnLaser=r,this.vertical=n,this.color="yellow",this.gravity.y=0}update(t){switch(this.time+=t,this.state){case 0:{if(this.time>=st)this.time=0,this.state=1,this.color="yellow";break}case 1:{if(this.time>=Vt)this.time=0,this.state=0,this.color="red",this.spawnLaser();break}default:{console.error(`Should not be able to enter state ${this.state}`),this.state=0;break}}}handleCollision(t){}render(t,s){t.strokeStyle=this.color;let n=s.columnToScreen(this.pos.x),r=s.rowToScreen(this.pos.y),i=r+k;t.beginPath(),t.moveTo(n,i),t.lineTo(n+a/2,r),t.lineTo(n+a,i),t.lineTo(n,i),t.stroke(),t.strokeStyle="white",t.beginPath(),t.moveTo(n,r),t.lineTo(n+a,r),t.stroke()}}class It extends p{vertical;time=0;constructor(t,s,n,r){super(t+(F-ut)/2,s,ut,r,C);this.vertical=n,this.gravity.y=0}update(t){if(this.time+=t,this.time>=st)this.dead=!0}handleCollision(t){}render(t,s){t.fillStyle="red",t.fillRect(s.columnToScreen(this.pos.x),s.rowToScreen(this.pos.y),Wt,this.size.y*v)}}var Kt=2000;class Et extends p{minY;maxY;yMod;constructor(t,s){super(t+0.25,s+0.25,V,J,nt);this.gravity.y=0,this.yMod=Math.random()*0.5,this.maxY=s+0.3,this.minY=s+0.15,this.velocity.y=this.yMod}update(t){if(this.pos.y>=this.maxY)this.velocity.y=-this.yMod;else if(this.pos.y<=this.minY)this.velocity.y=this.yMod}handleCollision(t){if(t.type===H){let s=this.pos.y;this.pos.y=100,setTimeout(()=>{this.pos.y=s},Kt)}}render(t,s){t.fillStyle="#05D5FA",t.fillRect(s.columnToScreen(this.pos.x),s.rowToScreen(this.pos.y),Q,W)}}class Ct extends p{player;spawnBullet;color;time=0;state=0;constructor(t,s,n,r){super(t,s,F,U,E);this.player=n,this.spawnBullet=r,this.color="yellow",this.gravity.y=0}update(t){switch(this.time+=t,this.state){case 0:{if(this.pos.squareDistance(this.player.pos)<=Tt)this.color="red",this.state=1;break}case 1:{if(this.time>=Jt)this.time=0,this.state=2;break}case 2:{this.state=0,this.color="yellow",this.spawnBullet();break}default:{console.error(`Should not be able to enter state ${this.state}`),this.state=0;break}}}handleCollision(t){}render(t,s){t.strokeStyle=this.color;let n=s.columnToScreen(this.pos.x),r=s.rowToScreen(this.pos.y),i=k/2;t.strokeRect(n,r,a,i);let o=s.columnToScreen(this.player.pos.x),e=n+a/2.7,f=r+a/2,l=e+a/4,b=f+U/2,w=Math.max(n,Math.min(n+a,l+(o-e))),z=b+i,j=w-a/4,jt=b+i;t.beginPath(),t.moveTo(e,f),t.lineTo(l,b),t.lineTo(w,z),t.lineTo(j,jt),t.lineTo(e,f),t.stroke()}}class wt extends p{constructor(t,s,n){super(t,s+1.25,V,J,C);this.gravity.y=0,this.velocity=n.subtract(this.pos),this.velocity.normalize(),this.velocity.scalarMultiplyInPlace(Ht)}update(t){}handleCollision(t){this.dead=!0}render(t,s){t.fillStyle="red",t.fillRect(s.columnToScreen(this.pos.x),s.rowToScreen(this.pos.y),Q,W)}}class Nt extends m{ctx;transitionScene;camera;numCoins;levelDirector;staticEntities;dynamicEntities;constructor(t,s){super();this.ctx=t,this.transitionScene=s,this.camera=new dt,this.levelDirector=new mt}onEnter(){this.dynamicEntities=[],this.staticEntities=[],this.numCoins=0,this.dynamicEntities.push(new lt(2,12));let t=this.levelDirector.get(Qt),s=t.length;if(s!==N){console.error("Level should have 15 rows!");return}let n=t[0].length;for(let r=0;r<s;++r){let i=t[r];if(n!==i.length){console.error(`Every row in the level should have the same number of columns! (${n} !== ${i.length}).`);return}for(let o=0;o<n;++o){let e=i[o];if(e==="X")this.staticEntities.push(new ht(o,r));else if(e==="^")this.dynamicEntities.push(new St(o,r,!0,()=>{let f=this.raycast(new y(o,r)),l=f===null?N:r-f.pos.y-1;this.dynamicEntities.push(new It(o,r-l,!0,l))}));else if(e==="T")this.dynamicEntities.push(new Ct(o,r,this.dynamicEntities[0],()=>{this.dynamicEntities.push(new wt(o,r,this.dynamicEntities[0].pos))}));else if(e==="o")++this.numCoins,this.dynamicEntities.push(new ct(o,r));else if(e=="b")this.dynamicEntities.push(new Et(o,r));else if(e==="H")this.dynamicEntities.push(new pt(o,r,n));else if(e==="V")this.dynamicEntities.push(new bt(o,r));else if(e!=="-")console.error(`Unhandled tile type: ${i[o]}`)}}}update(t){let s=this.dynamicEntities.length,n=this.staticEntities.length,r,i=0;for(;i<s;++i){let e=this.dynamicEntities[i];if(e.update(t),e.dead){if(i==0)break;this.dynamicEntities.splice(i,1),--i,--s}e.physicsUpdate(t);for(r=i+1;r<s;++r)e.collision(this.dynamicEntities[r]);for(r=0;r<n;++r)e.collision(this.staticEntities[r])}let o=this.dynamicEntities[0];if(o.coinsCollected>=this.numCoins)if(this.levelDirector.playerIsOnLastLevel)this.transitionScene.targetScene=L,this.changeScene=S;else this.transitionScene.targetScene=M,this.changeScene=S;if(o.dead)this.transitionScene.targetScene=B,this.changeScene=S}render(){this.ctx.clearRect(0,0,g,I),this.camera.update(this.dynamicEntities[0].pos.x);let t=this.staticEntities.length,s=0;for(;s<t;++s)this.staticEntities[s].render(this.ctx,this.camera);t=this.dynamicEntities.length;for(s=0;s<t;++s)this.dynamicEntities[s].render(this.ctx,this.camera)}_onExit(){let t=this.dynamicEntities[0];this.levelDirector.update(!t.dead,Math.floor(t.maxColumn))}raycast(t){let s=this.staticEntities.length,n;while(t.y>=0){for(n=0;n<s;++n){let r=this.staticEntities[n];if(t.equals(r.pos))return r}--t.y}return null}}class $t extends m{ctx;constructor(t){super();this.ctx=t}onEnter(){this.ctx.clearRect(0,0,g,I),this.ctx.font="30px Arial",this.ctx.fillStyle="white",this.ctx.fillText("You won! Congratulations!",170,I/2)}update(t){}render(){}_onExit(){}}class zt extends m{targetScene=O;timer=0;ctx;constructor(t){super();this.ctx=t}onEnter(){}update(t){if(this.timer+=t,this.timer>0.6)this.changeScene=this.targetScene}render(){let t=this.timer/0.5;this.ctx.fillStyle=`rgba(0,0,0, ${t})`,this.ctx.fillRect(0,0,g,I)}_onExit(){this.timer=0}}class Rt extends m{ctx;transitionScene;constructor(t,s){super();this.ctx=t,this.transitionScene=s}onEnter(){c.clear(),this.ctx.fillStyle=q,this.ctx.font="48px Arial",this.ctx.fillText("YOU WON",250,200),this.ctx.fillStyle="white",this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to keep going.",180,400)}update(t){if(c.isKeyDown(14))this.transitionScene.targetScene=R,this.changeScene=S}render(){}_onExit(){}}class kt extends m{ctx;transitionScene;constructor(t,s){super();this.ctx=t,this.transitionScene=s}onEnter(){c.clear(),this.ctx.fillStyle="red",this.ctx.font="48px Arial",this.ctx.fillText("YOU LOST",243,200),this.ctx.fillStyle="white",this.ctx.font="30px Arial",this.ctx.fillText("Press 'space' to try again.",195,400)}update(t){if(c.isKeyDown(14))this.transitionScene.targetScene=R,this.changeScene=S}render(){}_onExit(){}}class Ft{canvas;ctx;currentScene;sceneManager;constructor(){this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id","canvas"),this.canvas.width=g,this.canvas.height=I,this.ctx=this.canvas.getContext("2d"),document.getElementById("game").appendChild(this.canvas);let t=new zt(this.ctx);this.sceneManager=new ot,this.sceneManager.registerScene(O,new ft(this.ctx,t)),this.sceneManager.registerScene(R,new Nt(this.ctx,t)),this.sceneManager.registerScene(L,new $t(this.ctx)),this.sceneManager.registerScene(S,t),this.sceneManager.registerScene(M,new Rt(this.ctx,t)),this.sceneManager.registerScene(B,new kt(this.ctx,t)),this.currentScene=this.sceneManager.getScene(O),this.currentScene.onEnter()}start(){let t=0,s=(n)=>{let r=Math.min(0.05,(n-t)/1000);t=n,this.currentScene.update(r),this.currentScene.render();let i=this.currentScene.changeScene;if(i!==void 0)this.currentScene.onExit(),this.currentScene=this.sceneManager.getScene(i),this.currentScene.onEnter();window.requestAnimationFrame(s)};window.requestAnimationFrame(s)}}window.addEventListener("load",()=>{c.init(),new Ft().start()});
